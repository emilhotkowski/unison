<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-comment">-- | This module contains sqlite-specific operations on high-level &quot;parser-typechecker&quot; types all in the Transaction</span><span>
</span><span id="line-4"></span><span class="hs-comment">-- monad.</span><span>
</span><span id="line-5"></span><span class="hs-comment">--</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- The Codebase record-of-functions wraps this functionality, and runs each transaction to IO, so that the operations'</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- are unified with non-sqlite operations in the Codebase interface, like 'appendReflog'.</span><span>
</span><span id="line-8"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Unison.Codebase.SqliteCodebase.Operations</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ifor</span></span><span class="hs-special">)</span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bifunctor</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Bifunctor</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">bimap</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">second</span></span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bitraversable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">bitraverse</span></span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Either.Extra</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">List</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.List.NonEmpty</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NEList</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List.NonEmpty.Extra</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NonEmpty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(:|)</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">maximum1</span></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Text</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Branch</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">V2Branch</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Causal</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">V2Causal</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.HashTags</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">CausalHash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">unCausalHash</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Reference</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C.Reference</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Referent</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C.Referent</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.DbId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ObjectId</span></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.NamedRef</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.ObjectType</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">OT</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Operations</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Ops</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Queries</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Q</span></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.V2.Decl</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">saveDeclComponent</span></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.V2.HashHandle</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">v2HashHandle</span></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.V2.Term</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">saveTermComponent</span></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">U.Util.Cache</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Cache</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">U.Util.Hash</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">H2</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Unison.Builtin.html"><span class="hs-identifier">Unison.Builtin</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Builtins</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Codebase.Branch.html"><span class="hs-identifier">Unison.Codebase.Branch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.Branch.Type.html#Branch"><span class="hs-identifier">Branch</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Unison.Codebase.Branch.html"><span class="hs-identifier">Unison.Codebase.Branch</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Branch</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Unison.Codebase.Branch.Names.html"><span class="hs-identifier">Unison.Codebase.Branch.Names</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">V1Branch</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Unison.Codebase.Causal.Type.html"><span class="hs-identifier">Unison.Codebase.Causal.Type</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Causal</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Codebase.Patch.html"><span class="hs-identifier">Unison.Codebase.Patch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.Patch.html#Patch"><span class="hs-identifier">Patch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Codebase.Path.html"><span class="hs-identifier">Unison.Codebase.Path</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.Path.html#Path"><span class="hs-identifier">Path</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Unison.Codebase.Path.html"><span class="hs-identifier">Unison.Codebase.Path</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Path</span></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Codebase.ShortBranchHash.html"><span class="hs-identifier">Unison.Codebase.ShortBranchHash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.ShortBranchHash.html#ShortBranchHash"><span class="hs-identifier">ShortBranchHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Conversions.html"><span class="hs-identifier">Unison.Codebase.SqliteCodebase.Conversions</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Cv</span></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.ConstructorReference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">GConstructorReference</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.ConstructorType</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CT</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.DataDeclaration</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Decl</span></span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.DataDeclaration</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Decl</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Hash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Hash</span></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Unison.Hashing.V2.Convert.html"><span class="hs-identifier">Unison.Hashing.V2.Convert</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Hashing</span></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Name</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Name</span></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Name</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Name</span></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.NameSegment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NameSegment</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Names</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Names</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Names</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Names</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Names</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Names.Scoped</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ScopedNames</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Parser.Ann.html"><span class="hs-identifier">Unison.Parser.Ann</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Parser.Ann.html#Ann"><span class="hs-identifier">Ann</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Prelude</span></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Reference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Reference</span></span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Reference</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Reference</span></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Referent</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Referent</span></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.ShortHash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ShortHash</span></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.ShortHash</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SH</span></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.ShortHash</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ShortHash</span></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Sqlite</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Transaction</span></span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Sqlite</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Sqlite</span></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Sqlite.Transaction</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Sqlite</span></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Symbol</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Symbol</span></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Term</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Term</span></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Term</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Term</span></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Type</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Type</span></span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Type</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Type</span></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Relation</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Rel</span></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Set</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Unison.WatchKind</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">UF</span></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">UnliftIO.STM</span></span><span>
</span><span id="line-77"></span><span>
</span><span id="line-78"></span><span class="hs-comment">------------------------------------------------------------------------------------------------------------------------</span><span>
</span><span id="line-79"></span><span class="hs-comment">-- Buffer entry</span><span>
</span><span id="line-80"></span><span>
</span><span id="line-81"></span><span class="hs-comment">-- 1) buffer up the component</span><span>
</span><span id="line-82"></span><span class="hs-comment">-- 2) in the event that the component is complete, then what?</span><span>
</span><span id="line-83"></span><span class="hs-comment">--  * can write component provided all of its dependency components are complete.</span><span>
</span><span id="line-84"></span><span class="hs-comment">--    if dependency not complete,</span><span>
</span><span id="line-85"></span><span class="hs-comment">--    register yourself to be written when that dependency is complete</span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span class="hs-comment">-- an entry for a single hash</span><span>
</span><span id="line-88"></span><span class="hs-keyword">data</span><span> </span><span id="BufferEntry"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-var">BufferEntry</span></a></span></span><span> </span><span id="local-6989586621680729954"><span class="annot"><a href="#local-6989586621680729954"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="BufferEntry"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-var">BufferEntry</span></a></span></span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- First, you are waiting for the cycle to fill up with all elements</span><span>
</span><span id="line-90"></span><span>    </span><span class="hs-comment">-- Then, you check: are all dependencies of the cycle in the db?</span><span>
</span><span id="line-91"></span><span>    </span><span class="hs-comment">--   If yes: write yourself to database and trigger check of dependents</span><span>
</span><span id="line-92"></span><span>    </span><span class="hs-comment">--   If no: just wait, do nothing</span><span>
</span><span id="line-93"></span><span>    </span><span id="%24sel%3AbeComponentTargetSize%3ABufferEntry"><span class="annot"><span class="annottext">BufferEntry a -&gt; Maybe Word64
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#%24sel%3AbeComponentTargetSize%3ABufferEntry"><span class="hs-identifier hs-var hs-var">beComponentTargetSize</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span class="hs-special">,</span><span>
</span><span id="line-94"></span><span>    </span><span id="%24sel%3AbeComponent%3ABufferEntry"><span class="annot"><span class="annottext">BufferEntry a -&gt; Map Word64 a
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#%24sel%3AbeComponent%3ABufferEntry"><span class="hs-identifier hs-var hs-var">beComponent</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Pos</span></span><span> </span><span class="annot"><a href="#local-6989586621680729954"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-95"></span><span>    </span><span id="%24sel%3AbeMissingDependencies%3ABufferEntry"><span class="annot"><span class="annottext">BufferEntry a -&gt; Set Hash
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#%24sel%3AbeMissingDependencies%3ABufferEntry"><span class="hs-identifier hs-var hs-var">beMissingDependencies</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span class="hs-special">,</span><span>
</span><span id="line-96"></span><span>    </span><span id="%24sel%3AbeWaitingDependents%3ABufferEntry"><span class="annot"><span class="annottext">BufferEntry a -&gt; Set Hash
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#%24sel%3AbeWaitingDependents%3ABufferEntry"><span class="hs-identifier hs-var hs-var">beWaitingDependents</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span>
</span><span id="line-97"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-98"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680729643"><span id="local-6989586621680729645"><span class="annot"><span class="annottext">BufferEntry a -&gt; BufferEntry a -&gt; Bool
(BufferEntry a -&gt; BufferEntry a -&gt; Bool)
-&gt; (BufferEntry a -&gt; BufferEntry a -&gt; Bool) -&gt; Eq (BufferEntry a)
forall a. Eq a =&gt; BufferEntry a -&gt; BufferEntry a -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: BufferEntry a -&gt; BufferEntry a -&gt; Bool
$c/= :: forall a. Eq a =&gt; BufferEntry a -&gt; BufferEntry a -&gt; Bool
== :: BufferEntry a -&gt; BufferEntry a -&gt; Bool
$c== :: forall a. Eq a =&gt; BufferEntry a -&gt; BufferEntry a -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680729636"><span id="local-6989586621680729638"><span id="local-6989586621680729640"><span class="annot"><span class="annottext">Int -&gt; BufferEntry a -&gt; ShowS
[BufferEntry a] -&gt; ShowS
BufferEntry a -&gt; String
(Int -&gt; BufferEntry a -&gt; ShowS)
-&gt; (BufferEntry a -&gt; String)
-&gt; ([BufferEntry a] -&gt; ShowS)
-&gt; Show (BufferEntry a)
forall a. Show a =&gt; Int -&gt; BufferEntry a -&gt; ShowS
forall a. Show a =&gt; [BufferEntry a] -&gt; ShowS
forall a. Show a =&gt; BufferEntry a -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [BufferEntry a] -&gt; ShowS
$cshowList :: forall a. Show a =&gt; [BufferEntry a] -&gt; ShowS
show :: BufferEntry a -&gt; String
$cshow :: forall a. Show a =&gt; BufferEntry a -&gt; String
showsPrec :: Int -&gt; BufferEntry a -&gt; ShowS
$cshowsPrec :: forall a. Show a =&gt; Int -&gt; BufferEntry a -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span id="local-6989586621680729634"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#prettyBufferEntry"><span class="hs-identifier hs-type">prettyBufferEntry</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="#local-6989586621680729634"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-type">BufferEntry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680729634"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span></span><span>
</span><span id="line-101"></span><span id="prettyBufferEntry"><span class="annot"><span class="annottext">prettyBufferEntry :: Hash -&gt; BufferEntry a -&gt; String
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#prettyBufferEntry"><span class="hs-identifier hs-var hs-var">prettyBufferEntry</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680729632"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729632"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-type">BufferEntry</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680729628"><span id="local-6989586621680729629"><span id="local-6989586621680729630"><span id="local-6989586621680729631"><span class="annot"><span class="annottext">Maybe Word64
Map Word64 a
Set Hash
beWaitingDependents :: Set Hash
beMissingDependencies :: Set Hash
beComponent :: Map Word64 a
beComponentTargetSize :: Maybe Word64
$sel:beWaitingDependents:BufferEntry :: forall a. BufferEntry a -&gt; Set Hash
$sel:beMissingDependencies:BufferEntry :: forall a. BufferEntry a -&gt; Set Hash
$sel:beComponent:BufferEntry :: forall a. BufferEntry a -&gt; Map Word64 a
$sel:beComponentTargetSize:BufferEntry :: forall a. BufferEntry a -&gt; Maybe Word64
</span><a href="#local-6989586621680729628"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-102"></span><span>  </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;BufferEntry &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729632"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\n&quot;</span></span><span>
</span><span id="line-103"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;  { beComponentTargetSize = &quot;</span></span><span>
</span><span id="line-104"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Maybe Word64 -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Maybe Word64
</span><a href="#local-6989586621680729631"><span class="hs-identifier hs-var">beComponentTargetSize</span></a></span><span>
</span><span id="line-105"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\n&quot;</span></span><span>
</span><span id="line-106"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;  , beComponent = &quot;</span></span><span>
</span><span id="line-107"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Map Word64 a -&gt; Int
forall k a. Map k a -&gt; Int
</span><span class="hs-identifier hs-var">Map.size</span></span><span> </span><span class="annot"><span class="annottext">Map Word64 a
</span><a href="#local-6989586621680729630"><span class="hs-identifier hs-var">beComponent</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span>
</span><span id="line-108"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">[(Word64, a)] -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">([(Word64, a)] -&gt; String) -&gt; [(Word64, a)] -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map Word64 a -&gt; [(Word64, a)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span> </span><span class="annot"><span class="annottext">Map Word64 a
</span><a href="#local-6989586621680729630"><span class="hs-identifier hs-var">beComponent</span></a></span><span>
</span><span id="line-109"></span><span>      </span><span class="hs-keyword">else</span><span>
</span><span id="line-110"></span><span>        </span><span class="annot"><span class="annottext">[(Word64, a)] -&gt; Maybe String -&gt; String -&gt; Maybe String -&gt; String
forall (f :: * -&gt; *) a.
(Foldable f, Show a) =&gt;
f a -&gt; Maybe String -&gt; String -&gt; Maybe String -&gt; String
</span><a href="#local-6989586621680729623"><span class="hs-identifier hs-var">mkString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Word64 a -&gt; [(Word64, a)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span> </span><span class="annot"><span class="annottext">Map Word64 a
</span><a href="#local-6989586621680729630"><span class="hs-identifier hs-var">beComponent</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Maybe String
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\n      [ &quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;      , &quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Maybe String
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;]\n&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;  , beMissingDependencies =&quot;</span></span><span>
</span><span id="line-112"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Set Hash -&gt; Int
forall a. Set a -&gt; Int
</span><span class="hs-identifier hs-var">Set.size</span></span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680729629"><span class="hs-identifier hs-var">beMissingDependencies</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span>
</span><span id="line-113"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">[Hash] -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">([Hash] -&gt; String) -&gt; [Hash] -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Set Hash -&gt; [Hash]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680729629"><span class="hs-identifier hs-var">beMissingDependencies</span></a></span><span>
</span><span id="line-114"></span><span>            </span><span class="hs-keyword">else</span><span>
</span><span id="line-115"></span><span>              </span><span class="annot"><span class="annottext">[Hash] -&gt; Maybe String -&gt; String -&gt; Maybe String -&gt; String
forall (f :: * -&gt; *) a.
(Foldable f, Show a) =&gt;
f a -&gt; Maybe String -&gt; String -&gt; Maybe String -&gt; String
</span><a href="#local-6989586621680729623"><span class="hs-identifier hs-var">mkString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set Hash -&gt; [Hash]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680729629"><span class="hs-identifier hs-var">beMissingDependencies</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Maybe String
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\n      [ &quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;      , &quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Maybe String
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;]\n&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span>                </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;  , beWaitingDependents =&quot;</span></span><span>
</span><span id="line-117"></span><span>                </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Set Hash -&gt; Int
forall a. Set a -&gt; Int
</span><span class="hs-identifier hs-var">Set.size</span></span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680729628"><span class="hs-identifier hs-var">beWaitingDependents</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span>
</span><span id="line-118"></span><span>                  </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">[Hash] -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">([Hash] -&gt; String) -&gt; [Hash] -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Set Hash -&gt; [Hash]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680729628"><span class="hs-identifier hs-var">beWaitingDependents</span></a></span><span>
</span><span id="line-119"></span><span>                  </span><span class="hs-keyword">else</span><span>
</span><span id="line-120"></span><span>                    </span><span class="annot"><span class="annottext">[Hash] -&gt; Maybe String -&gt; String -&gt; Maybe String -&gt; String
forall (f :: * -&gt; *) a.
(Foldable f, Show a) =&gt;
f a -&gt; Maybe String -&gt; String -&gt; Maybe String -&gt; String
</span><a href="#local-6989586621680729623"><span class="hs-identifier hs-var">mkString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set Hash -&gt; [Hash]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680729628"><span class="hs-identifier hs-var">beWaitingDependents</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Maybe String
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\n      [ &quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;      , &quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Maybe String
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;]\n&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-121"></span><span>                      </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;  }&quot;</span></span><span>
</span><span id="line-122"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-123"></span><span>    </span><span id="local-6989586621680729943"><span id="local-6989586621680729944"><span class="annot"><a href="#local-6989586621680729623"><span class="hs-identifier hs-type">mkString</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Foldable</span></span><span> </span><span class="annot"><a href="#local-6989586621680729944"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="#local-6989586621680729943"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680729944"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680729943"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span></span></span><span>
</span><span id="line-124"></span><span>    </span><span id="local-6989586621680729623"><span class="annot"><span class="annottext">mkString :: f a -&gt; Maybe String -&gt; String -&gt; Maybe String -&gt; String
</span><a href="#local-6989586621680729623"><span class="hs-identifier hs-var hs-var">mkString</span></a></span></span><span> </span><span id="local-6989586621680729620"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621680729620"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span id="local-6989586621680729619"><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621680729619"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621680729618"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680729618"><span class="hs-identifier hs-var">middle</span></a></span></span><span> </span><span id="local-6989586621680729617"><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621680729617"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-125"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; Maybe String -&gt; String
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621680729619"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; [String] -&gt; String
forall a. [a] -&gt; [[a]] -&gt; [a]
</span><span class="hs-identifier hs-var">List.intercalate</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680729618"><span class="hs-identifier hs-var">middle</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; String) -&gt; [a] -&gt; [String]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">f a -&gt; [a]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621680729620"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe String -&gt; String
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621680729617"><span class="hs-identifier hs-var">end</span></a></span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span class="hs-keyword">type</span><span> </span><span id="TermBufferEntry"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#TermBufferEntry"><span class="hs-identifier hs-var">TermBufferEntry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-type">BufferEntry</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><a href="Unison.Parser.Ann.html#Ann"><span class="hs-identifier hs-type">Ann</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><a href="Unison.Parser.Ann.html#Ann"><span class="hs-identifier hs-type">Ann</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span class="hs-keyword">type</span><span> </span><span id="DeclBufferEntry"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#DeclBufferEntry"><span class="hs-identifier hs-var">DeclBufferEntry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-type">BufferEntry</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Decl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><a href="Unison.Parser.Ann.html#Ann"><span class="hs-identifier hs-type">Ann</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span id="local-6989586621680729906"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#getBuffer"><span class="hs-identifier hs-type">getBuffer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-type">BufferEntry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680729906"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-type">BufferEntry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680729906"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-132"></span><span id="getBuffer"><span class="annot"><span class="annottext">getBuffer :: TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; IO (BufferEntry a)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getBuffer"><span class="hs-identifier hs-var hs-var">getBuffer</span></a></span></span><span> </span><span id="local-6989586621680729611"><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
</span><a href="#local-6989586621680729611"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span id="local-6989586621680729610"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729610"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-133"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Map Hash (BufferEntry a) -&gt; Maybe (BufferEntry a)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729610"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Hash (BufferEntry a) -&gt; Maybe (BufferEntry a))
-&gt; IO (Map Hash (BufferEntry a)) -&gt; IO (Maybe (BufferEntry a))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a)) -&gt; IO (Map Hash (BufferEntry a))
forall (m :: * -&gt; *) a. MonadIO m =&gt; TVar a -&gt; m a
</span><span class="hs-identifier hs-var">readTVarIO</span></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
</span><a href="#local-6989586621680729611"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IO (Maybe (BufferEntry a))
-&gt; (Maybe (BufferEntry a) -&gt; BufferEntry a) -&gt; IO (BufferEntry a)
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-134"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680729606"><span class="annot"><span class="annottext">BufferEntry a
</span><a href="#local-6989586621680729606"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">BufferEntry a
</span><a href="#local-6989586621680729606"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-135"></span><span>    </span><span class="annot"><span class="annottext">Maybe (BufferEntry a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Word64
-&gt; Map Word64 a -&gt; Set Hash -&gt; Set Hash -&gt; BufferEntry a
forall a.
Maybe Word64
-&gt; Map Word64 a -&gt; Set Hash -&gt; Set Hash -&gt; BufferEntry a
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-var">BufferEntry</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Word64
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Map Word64 a
forall k a. Map k a
</span><span class="hs-identifier hs-var">Map.empty</span></span><span> </span><span class="annot"><span class="annottext">Set Hash
forall a. Set a
</span><span class="hs-identifier hs-var">Set.empty</span></span><span> </span><span class="annot"><span class="annottext">Set Hash
forall a. Set a
</span><span class="hs-identifier hs-var">Set.empty</span></span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span id="local-6989586621680729905"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#putBuffer"><span class="hs-identifier hs-type">putBuffer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-type">BufferEntry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680729905"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-type">BufferEntry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680729905"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-138"></span><span id="putBuffer"><span class="annot"><span class="annottext">putBuffer :: TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; BufferEntry a -&gt; IO ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putBuffer"><span class="hs-identifier hs-var hs-var">putBuffer</span></a></span></span><span> </span><span id="local-6989586621680729602"><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
</span><a href="#local-6989586621680729602"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span id="local-6989586621680729601"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729601"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621680729600"><span class="annot"><span class="annottext">BufferEntry a
</span><a href="#local-6989586621680729600"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-139"></span><span>  </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; STM a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
-&gt; (Map Hash (BufferEntry a) -&gt; Map Hash (BufferEntry a)) -&gt; STM ()
forall a. TVar a -&gt; (a -&gt; a) -&gt; STM ()
</span><span class="hs-identifier hs-var">modifyTVar'</span></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
</span><a href="#local-6989586621680729602"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash
-&gt; BufferEntry a
-&gt; Map Hash (BufferEntry a)
-&gt; Map Hash (BufferEntry a)
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insert</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729601"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">BufferEntry a
</span><a href="#local-6989586621680729600"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-140"></span><span>
</span><span id="line-141"></span><span id="local-6989586621680729887"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#removeBuffer"><span class="hs-identifier hs-type">removeBuffer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-type">BufferEntry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680729887"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-142"></span><span id="removeBuffer"><span class="annot"><span class="annottext">removeBuffer :: TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; IO ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#removeBuffer"><span class="hs-identifier hs-var hs-var">removeBuffer</span></a></span></span><span> </span><span id="local-6989586621680729595"><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
</span><a href="#local-6989586621680729595"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span id="local-6989586621680729594"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729594"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-143"></span><span>  </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; STM a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
-&gt; (Map Hash (BufferEntry a) -&gt; Map Hash (BufferEntry a)) -&gt; STM ()
forall a. TVar a -&gt; (a -&gt; a) -&gt; STM ()
</span><span class="hs-identifier hs-var">modifyTVar'</span></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
</span><a href="#local-6989586621680729595"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Map Hash (BufferEntry a) -&gt; Map Hash (BufferEntry a)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.delete</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729594"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span>
</span><span id="line-145"></span><span id="local-6989586621680729821"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#addBufferDependent"><span class="hs-identifier hs-type">addBufferDependent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-type">BufferEntry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680729821"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-146"></span><span id="addBufferDependent"><span class="annot"><span class="annottext">addBufferDependent :: Hash -&gt; TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; IO ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#addBufferDependent"><span class="hs-identifier hs-var hs-var">addBufferDependent</span></a></span></span><span> </span><span id="local-6989586621680729591"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729591"><span class="hs-identifier hs-var">dependent</span></a></span></span><span> </span><span id="local-6989586621680729590"><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
</span><a href="#local-6989586621680729590"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span id="local-6989586621680729589"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729589"><span class="hs-keyword hs-var">dependency</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-147"></span><span>  </span><span id="local-6989586621680729588"><span class="annot"><span class="annottext">BufferEntry a
</span><a href="#local-6989586621680729588"><span class="hs-identifier hs-var">be</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; IO (BufferEntry a)
forall a.
TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; IO (BufferEntry a)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getBuffer"><span class="hs-identifier hs-var">getBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
</span><a href="#local-6989586621680729590"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729589"><span class="hs-keyword hs-var">dependency</span></a></span><span>
</span><span id="line-148"></span><span>  </span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; BufferEntry a -&gt; IO ()
forall a.
TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; BufferEntry a -&gt; IO ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putBuffer"><span class="hs-identifier hs-var">putBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
</span><a href="#local-6989586621680729590"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729589"><span class="hs-keyword hs-var">dependency</span></a></span><span> </span><span class="annot"><span class="annottext">BufferEntry a
</span><a href="#local-6989586621680729588"><span class="hs-identifier hs-var">be</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:beWaitingDependents:BufferEntry :: Set Hash
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#%24sel%3AbeWaitingDependents%3ABufferEntry"><span class="hs-identifier hs-var">beWaitingDependents</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Set Hash -&gt; Set Hash
forall a. Ord a =&gt; a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">Set.insert</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729591"><span class="hs-identifier hs-var">dependent</span></a></span><span> </span><span class="annot"><span class="annottext">(Set Hash -&gt; Set Hash) -&gt; Set Hash -&gt; Set Hash
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BufferEntry a -&gt; Set Hash
forall a. BufferEntry a -&gt; Set Hash
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#%24sel%3AbeWaitingDependents%3ABufferEntry"><span class="hs-identifier hs-var hs-var">beWaitingDependents</span></a></span><span> </span><span class="annot"><span class="annottext">BufferEntry a
</span><a href="#local-6989586621680729588"><span class="hs-identifier hs-var">be</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-149"></span><span>
</span><span id="line-150"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#tryFlushBuffer"><span class="hs-identifier hs-type">tryFlushBuffer</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-151"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680729820"><span class="annot"><a href="#local-6989586621680729820"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-152"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="#local-6989586621680729820"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-153"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-type">BufferEntry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680729820"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-154"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">H2.Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621680729820"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-155"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-156"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-157"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span id="tryFlushBuffer"><span class="annot"><span class="annottext">tryFlushBuffer :: TVar (Map Hash (BufferEntry a))
-&gt; (Hash -&gt; [a] -&gt; Transaction ())
-&gt; (Hash -&gt; Transaction ())
-&gt; Hash
-&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#tryFlushBuffer"><span class="hs-identifier hs-var hs-var">tryFlushBuffer</span></a></span></span><span> </span><span id="local-6989586621680729585"><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
</span><a href="#local-6989586621680729585"><span class="hs-identifier hs-var">buf</span></a></span></span><span> </span><span id="local-6989586621680729584"><span class="annot"><span class="annottext">Hash -&gt; [a] -&gt; Transaction ()
</span><a href="#local-6989586621680729584"><span class="hs-identifier hs-var">saveComponent</span></a></span></span><span> </span><span id="local-6989586621680729583"><span class="annot"><span class="annottext">Hash -&gt; Transaction ()
</span><a href="#local-6989586621680729583"><span class="hs-identifier hs-var">tryWaiting</span></a></span></span><span> </span><span id="local-6989586621680729582"><span class="annot"><span class="annottext">h :: Hash
</span><a href="#local-6989586621680729582"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Hash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#hash1to2"><span class="hs-identifier hs-var">Cv.hash1to2</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621680729580"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729580"><span class="hs-identifier hs-var">h2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-159"></span><span>  </span><span class="hs-comment">-- skip if it has already been flushed</span><span>
</span><span id="line-160"></span><span>  </span><span class="annot"><span class="annottext">Transaction Bool -&gt; Transaction () -&gt; Transaction ()
forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m () -&gt; m ()
</span><span class="hs-identifier hs-var">unlessM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Transaction Bool
</span><span class="hs-identifier hs-var">Ops.objectExistsForHash</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729580"><span class="hs-identifier hs-var">h2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-161"></span><span>    </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-type">BufferEntry</span></a></span><span> </span><span id="local-6989586621680729577"><span class="annot"><span class="annottext">Maybe Word64
</span><a href="#local-6989586621680729577"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span id="local-6989586621680729576"><span class="annot"><span class="annottext">Map Word64 a
</span><a href="#local-6989586621680729576"><span class="hs-identifier hs-var">comp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Set Hash -&gt; Set Hash
forall a. Ord a =&gt; a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">Set.delete</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729582"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621680729574"><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680729574"><span class="hs-identifier hs-var">missing</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680729573"><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680729573"><span class="hs-identifier hs-var">waiting</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (BufferEntry a) -&gt; Transaction (BufferEntry a)
forall a. IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; IO (BufferEntry a)
forall a.
TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; IO (BufferEntry a)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getBuffer"><span class="hs-identifier hs-var">getBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
</span><a href="#local-6989586621680729585"><span class="hs-identifier hs-var">buf</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729582"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-162"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Word64
</span><a href="#local-6989586621680729577"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-163"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680729571"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729571"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-164"></span><span>        </span><span id="local-6989586621680729570"><span class="annot"><span class="annottext">[Hash]
</span><a href="#local-6989586621680729570"><span class="hs-identifier hs-var">missing'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Hash -&gt; Transaction Bool) -&gt; [Hash] -&gt; Transaction [Hash]
forall (m :: * -&gt; *) a.
Applicative m =&gt;
(a -&gt; m Bool) -&gt; [a] -&gt; m [a]
</span><span class="hs-identifier hs-var">filterM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Transaction Bool -&gt; Transaction Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Transaction Bool -&gt; Transaction Bool)
-&gt; (Hash -&gt; Transaction Bool) -&gt; Hash -&gt; Transaction Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Transaction Bool
</span><span class="hs-identifier hs-var">Ops.objectExistsForHash</span></span><span> </span><span class="annot"><span class="annottext">(Hash -&gt; Transaction Bool)
-&gt; (Hash -&gt; Hash) -&gt; Hash -&gt; Transaction Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Hash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#hash1to2"><span class="hs-identifier hs-var">Cv.hash1to2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set Hash -&gt; [Hash]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680729574"><span class="hs-identifier hs-var">missing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[Hash] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Hash]
</span><a href="#local-6989586621680729570"><span class="hs-identifier hs-var">missing'</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729571"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Word64 a -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">Map Word64 a
</span><a href="#local-6989586621680729576"><span class="hs-identifier hs-var">comp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-167"></span><span>            </span><span class="annot"><span class="annottext">Hash -&gt; [a] -&gt; Transaction ()
</span><a href="#local-6989586621680729584"><span class="hs-identifier hs-var">saveComponent</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729580"><span class="hs-identifier hs-var">h2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Word64 a -&gt; [a]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">Map Word64 a
</span><a href="#local-6989586621680729576"><span class="hs-identifier hs-var">comp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>            </span><span class="annot"><span class="annottext">IO () -&gt; Transaction ()
forall a. IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; IO ()
forall a. TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; IO ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#removeBuffer"><span class="hs-identifier hs-var">removeBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
</span><a href="#local-6989586621680729585"><span class="hs-identifier hs-var">buf</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729582"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span>            </span><span class="annot"><span class="annottext">(Hash -&gt; Transaction ()) -&gt; Set Hash -&gt; Transaction ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Transaction ()
</span><a href="#local-6989586621680729583"><span class="hs-identifier hs-var">tryWaiting</span></a></span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680729573"><span class="hs-identifier hs-var">waiting</span></a></span><span>
</span><span id="line-170"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; Transaction ()
forall a. IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-171"></span><span>            </span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; BufferEntry a -&gt; IO ()
forall a.
TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; BufferEntry a -&gt; IO ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putBuffer"><span class="hs-identifier hs-var">putBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
</span><a href="#local-6989586621680729585"><span class="hs-identifier hs-var">buf</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729582"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">(BufferEntry a -&gt; IO ()) -&gt; BufferEntry a -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-172"></span><span>              </span><span class="annot"><span class="annottext">Maybe Word64
-&gt; Map Word64 a -&gt; Set Hash -&gt; Set Hash -&gt; BufferEntry a
forall a.
Maybe Word64
-&gt; Map Word64 a -&gt; Set Hash -&gt; Set Hash -&gt; BufferEntry a
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-var">BufferEntry</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; Maybe Word64
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729571"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Word64 a
</span><a href="#local-6989586621680729576"><span class="hs-identifier hs-var">comp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Hash] -&gt; Set Hash
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="annot"><span class="annottext">[Hash]
</span><a href="#local-6989586621680729570"><span class="hs-identifier hs-var">missing'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680729573"><span class="hs-identifier hs-var">waiting</span></a></span><span>
</span><span id="line-173"></span><span>      </span><span class="annot"><span class="annottext">Maybe Word64
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-174"></span><span>        </span><span class="hs-comment">-- it's never even been added, so there's nothing to do.</span><span>
</span><span id="line-175"></span><span>        </span><span class="annot"><span class="annottext">() -&gt; Transaction ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span class="hs-comment">------------------------------------------------------------------------------------------------------------------------</span><span>
</span><span id="line-178"></span><span class="hs-comment">-- Operations</span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#getTerm"><span class="hs-identifier hs-type">getTerm</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-181"></span><span>  </span><span class="hs-comment">-- | A 'getDeclType'-like lookup, possibly backed by a cache.</span><span>
</span><span id="line-182"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-183"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-184"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><a href="Unison.Parser.Ann.html#Ann"><span class="hs-identifier hs-type">Ann</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-185"></span><span id="getTerm"><span class="annot"><span class="annottext">getTerm :: (Reference -&gt; Transaction ConstructorType)
-&gt; Id -&gt; Transaction (Maybe (Term Symbol Ann))
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getTerm"><span class="hs-identifier hs-var hs-var">getTerm</span></a></span></span><span> </span><span id="local-6989586621680729560"><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680729560"><span class="hs-identifier hs-var">doGetDeclType</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span id="local-6989586621680729558"><span class="annot"><span class="annottext">h1 :: Hash
</span><a href="#local-6989586621680729558"><span class="hs-identifier hs-var">h1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Hash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#hash1to2"><span class="hs-identifier hs-var">Cv.hash1to2</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621680729557"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729557"><span class="hs-identifier hs-var">h2</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680729556"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729556"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-186"></span><span>  </span><span class="annot"><span class="annottext">MaybeT Transaction (Term Symbol Ann)
-&gt; Transaction (Maybe (Term Symbol Ann))
forall (m :: * -&gt; *) a. MaybeT m a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var hs-var">runMaybeT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-187"></span><span>    </span><span id="local-6989586621680729554"><span class="annot"><span class="annottext">Term Symbol
</span><a href="#local-6989586621680729554"><span class="hs-identifier hs-var">term2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id -&gt; MaybeT Transaction (Term Symbol)
</span><span class="hs-identifier hs-var">Ops.loadTermByReference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Word64 -&gt; Id
forall h. h -&gt; Word64 -&gt; Id' h
</span><span class="hs-identifier hs-var">C.Reference.Id</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729557"><span class="hs-identifier hs-var">h2</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729556"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-188"></span><span>    </span><span class="annot"><span class="annottext">Transaction (Term Symbol Ann)
-&gt; MaybeT Transaction (Term Symbol Ann)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash
-&gt; (Reference -&gt; Transaction ConstructorType)
-&gt; Term Symbol
-&gt; Transaction (Term Symbol Ann)
forall (m :: * -&gt; *).
Monad m =&gt;
Hash
-&gt; (Reference -&gt; m ConstructorType)
-&gt; Term Symbol
-&gt; m (Term Symbol Ann)
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#term2to1"><span class="hs-identifier hs-var">Cv.term2to1</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729558"><span class="hs-identifier hs-var">h1</span></a></span><span> </span><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680729560"><span class="hs-identifier hs-var">doGetDeclType</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol
</span><a href="#local-6989586621680729554"><span class="hs-identifier hs-var">term2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#getDeclType"><span class="hs-identifier hs-type">getDeclType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span>
</span><span id="line-191"></span><span id="getDeclType"><span class="annot"><span class="annottext">getDeclType :: Reference -&gt; Transaction ConstructorType
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getDeclType"><span class="hs-identifier hs-var hs-var">getDeclType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-192"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">C.Reference.ReferenceBuiltin</span></span><span> </span><span id="local-6989586621680729547"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680729547"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-193"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680729546"><span class="annot"><span class="annottext">err :: a
</span><a href="#local-6989586621680729546"><span class="hs-identifier hs-var hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-194"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; a
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; a) -&gt; String -&gt; a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-195"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;I don't know about the builtin type ##&quot;</span></span><span>
</span><span id="line-196"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680729547"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-197"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;, but I've been asked for it's ConstructorType.&quot;</span></span><span>
</span><span id="line-198"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">ConstructorType -&gt; Transaction ConstructorType
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ConstructorType -&gt; Transaction ConstructorType)
-&gt; (Maybe ConstructorType -&gt; ConstructorType)
-&gt; Maybe ConstructorType
-&gt; Transaction ConstructorType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ConstructorType -&gt; Maybe ConstructorType -&gt; ConstructorType
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">ConstructorType
forall a. a
</span><a href="#local-6989586621680729546"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe ConstructorType -&gt; Transaction ConstructorType)
-&gt; Maybe ConstructorType -&gt; Transaction ConstructorType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-199"></span><span>          </span><span class="annot"><span class="annottext">Reference -&gt; Map Reference ConstructorType -&gt; Maybe ConstructorType
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Reference
</span><span class="hs-identifier hs-var">Reference.Builtin</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680729547"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Reference ConstructorType
</span><a href="Unison.Builtin.html#builtinConstructorType"><span class="hs-identifier hs-var">Builtins.builtinConstructorType</span></a></span><span>
</span><span id="line-200"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">C.Reference.ReferenceDerived</span></span><span> </span><span id="local-6989586621680729541"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621680729541"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Transaction ConstructorType
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#expectDeclTypeById"><span class="hs-identifier hs-var">expectDeclTypeById</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621680729541"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#expectDeclTypeById"><span class="hs-identifier hs-type">expectDeclTypeById</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Id</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span>
</span><span id="line-203"></span><span id="expectDeclTypeById"><span class="annot"><span class="annottext">expectDeclTypeById :: Id -&gt; Transaction ConstructorType
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#expectDeclTypeById"><span class="hs-identifier hs-var hs-var">expectDeclTypeById</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DeclType -&gt; ConstructorType)
-&gt; Transaction DeclType -&gt; Transaction ConstructorType
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">DeclType -&gt; ConstructorType
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#decltype2to1"><span class="hs-identifier hs-var">Cv.decltype2to1</span></a></span><span> </span><span class="annot"><span class="annottext">(Transaction DeclType -&gt; Transaction ConstructorType)
-&gt; (Id -&gt; Transaction DeclType)
-&gt; Id
-&gt; Transaction ConstructorType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Transaction DeclType
</span><span class="hs-identifier hs-var">Ops.expectDeclTypeById</span></span><span>
</span><span id="line-204"></span><span>
</span><span id="line-205"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#getTypeOfTermImpl"><span class="hs-identifier hs-type">getTypeOfTermImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><a href="Unison.Parser.Ann.html#Ann"><span class="hs-identifier hs-type">Ann</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-206"></span><span id="getTypeOfTermImpl"><span class="annot"><span class="annottext">getTypeOfTermImpl :: Id -&gt; Transaction (Maybe (Type Symbol Ann))
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getTypeOfTermImpl"><span class="hs-identifier hs-var hs-var">getTypeOfTermImpl</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Hash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#hash1to2"><span class="hs-identifier hs-var">Cv.hash1to2</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621680729536"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729536"><span class="hs-identifier hs-var">h2</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680729535"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729535"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-207"></span><span>  </span><span class="annot"><span class="annottext">MaybeT Transaction (Type Symbol Ann)
-&gt; Transaction (Maybe (Type Symbol Ann))
forall (m :: * -&gt; *) a. MaybeT m a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var hs-var">runMaybeT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-208"></span><span>    </span><span id="local-6989586621680729534"><span class="annot"><span class="annottext">Type Symbol
</span><a href="#local-6989586621680729534"><span class="hs-identifier hs-var">type2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id -&gt; MaybeT Transaction (Type Symbol)
</span><span class="hs-identifier hs-var">Ops.loadTypeOfTermByTermReference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Word64 -&gt; Id
forall h. h -&gt; Word64 -&gt; Id' h
</span><span class="hs-identifier hs-var">C.Reference.Id</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729536"><span class="hs-identifier hs-var">h2</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729535"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span>    </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type Symbol -&gt; Type Symbol Ann
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#ttype2to1"><span class="hs-identifier hs-var">Cv.ttype2to1</span></a></span><span> </span><span class="annot"><span class="annottext">Type Symbol
</span><a href="#local-6989586621680729534"><span class="hs-identifier hs-var">type2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#getTermComponentWithTypes"><span class="hs-identifier hs-type">getTermComponentWithTypes</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-212"></span><span>  </span><span class="hs-comment">-- | A 'getDeclType'-like lookup, possibly backed by a cache.</span><span>
</span><span id="line-213"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-214"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-215"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><a href="Unison.Parser.Ann.html#Ann"><span class="hs-identifier hs-type">Ann</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><a href="Unison.Parser.Ann.html#Ann"><span class="hs-identifier hs-type">Ann</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-216"></span><span id="getTermComponentWithTypes"><span class="annot"><span class="annottext">getTermComponentWithTypes :: (Reference -&gt; Transaction ConstructorType)
-&gt; Hash -&gt; Transaction (Maybe [(Term Symbol Ann, Type Symbol Ann)])
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getTermComponentWithTypes"><span class="hs-identifier hs-var hs-var">getTermComponentWithTypes</span></a></span></span><span> </span><span id="local-6989586621680729530"><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680729530"><span class="hs-identifier hs-var">doGetDeclType</span></a></span></span><span> </span><span id="local-6989586621680729529"><span class="annot"><span class="annottext">h1 :: Hash
</span><a href="#local-6989586621680729529"><span class="hs-identifier hs-var">h1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Hash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#hash1to2"><span class="hs-identifier hs-var">Cv.hash1to2</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621680729528"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729528"><span class="hs-identifier hs-var">h2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-217"></span><span>  </span><span class="annot"><span class="annottext">MaybeT Transaction [(Term Symbol Ann, Type Symbol Ann)]
-&gt; Transaction (Maybe [(Term Symbol Ann, Type Symbol Ann)])
forall (m :: * -&gt; *) a. MaybeT m a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var hs-var">runMaybeT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-218"></span><span>    </span><span id="local-6989586621680729527"><span class="annot"><span class="annottext">[(Term Symbol, Type Symbol)]
</span><a href="#local-6989586621680729527"><span class="hs-identifier hs-var">tms</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Hash -&gt; MaybeT Transaction [(Term Symbol, Type Symbol)]
</span><span class="hs-identifier hs-var">Ops.loadTermComponent</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729528"><span class="hs-identifier hs-var">h2</span></a></span><span>
</span><span id="line-219"></span><span>    </span><span class="annot"><span class="annottext">[(Term Symbol, Type Symbol)]
-&gt; ((Term Symbol, Type Symbol)
    -&gt; MaybeT Transaction (Term Symbol Ann, Type Symbol Ann))
-&gt; MaybeT Transaction [(Term Symbol Ann, Type Symbol Ann)]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f (t b)
</span><span class="hs-identifier hs-var">for</span></span><span> </span><span class="annot"><span class="annottext">[(Term Symbol, Type Symbol)]
</span><a href="#local-6989586621680729527"><span class="hs-identifier hs-var">tms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Term Symbol -&gt; MaybeT Transaction (Term Symbol Ann))
-&gt; (Type Symbol -&gt; MaybeT Transaction (Type Symbol Ann))
-&gt; (Term Symbol, Type Symbol)
-&gt; MaybeT Transaction (Term Symbol Ann, Type Symbol Ann)
forall (t :: * -&gt; * -&gt; *) (f :: * -&gt; *) a c b d.
(Bitraversable t, Applicative f) =&gt;
(a -&gt; f c) -&gt; (b -&gt; f d) -&gt; t a b -&gt; f (t c d)
</span><span class="hs-identifier hs-var">bitraverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Transaction (Term Symbol Ann)
-&gt; MaybeT Transaction (Term Symbol Ann)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction (Term Symbol Ann)
 -&gt; MaybeT Transaction (Term Symbol Ann))
-&gt; (Term Symbol -&gt; Transaction (Term Symbol Ann))
-&gt; Term Symbol
-&gt; MaybeT Transaction (Term Symbol Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Hash
-&gt; (Reference -&gt; Transaction ConstructorType)
-&gt; Term Symbol
-&gt; Transaction (Term Symbol Ann)
forall (m :: * -&gt; *).
Monad m =&gt;
Hash
-&gt; (Reference -&gt; m ConstructorType)
-&gt; Term Symbol
-&gt; m (Term Symbol Ann)
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#term2to1"><span class="hs-identifier hs-var">Cv.term2to1</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729529"><span class="hs-identifier hs-var">h1</span></a></span><span> </span><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680729530"><span class="hs-identifier hs-var">doGetDeclType</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type Symbol Ann -&gt; MaybeT Transaction (Type Symbol Ann)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Type Symbol Ann -&gt; MaybeT Transaction (Type Symbol Ann))
-&gt; (Type Symbol -&gt; Type Symbol Ann)
-&gt; Type Symbol
-&gt; MaybeT Transaction (Type Symbol Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Type Symbol -&gt; Type Symbol Ann
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#ttype2to1"><span class="hs-identifier hs-var">Cv.ttype2to1</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-220"></span><span>
</span><span id="line-221"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#getTypeDeclaration"><span class="hs-identifier hs-type">getTypeDeclaration</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Decl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><a href="Unison.Parser.Ann.html#Ann"><span class="hs-identifier hs-type">Ann</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span id="getTypeDeclaration"><span class="annot"><span class="annottext">getTypeDeclaration :: Id -&gt; Transaction (Maybe (Decl Symbol Ann))
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getTypeDeclaration"><span class="hs-identifier hs-var hs-var">getTypeDeclaration</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span id="local-6989586621680729523"><span class="annot"><span class="annottext">h1 :: Hash
</span><a href="#local-6989586621680729523"><span class="hs-identifier hs-var">h1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Hash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#hash1to2"><span class="hs-identifier hs-var">Cv.hash1to2</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621680729522"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729522"><span class="hs-identifier hs-var">h2</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680729521"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729521"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-223"></span><span>  </span><span class="annot"><span class="annottext">MaybeT Transaction (Decl Symbol Ann)
-&gt; Transaction (Maybe (Decl Symbol Ann))
forall (m :: * -&gt; *) a. MaybeT m a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var hs-var">runMaybeT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-224"></span><span>    </span><span id="local-6989586621680729520"><span class="annot"><span class="annottext">Decl Symbol
</span><a href="#local-6989586621680729520"><span class="hs-identifier hs-var">decl2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id -&gt; MaybeT Transaction (Decl Symbol)
</span><span class="hs-identifier hs-var">Ops.loadDeclByReference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Word64 -&gt; Id
forall h. h -&gt; Word64 -&gt; Id' h
</span><span class="hs-identifier hs-var">C.Reference.Id</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729522"><span class="hs-identifier hs-var">h2</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729521"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-225"></span><span>    </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Decl Symbol -&gt; Decl Symbol Ann
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#decl2to1"><span class="hs-identifier hs-var">Cv.decl2to1</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729523"><span class="hs-identifier hs-var">h1</span></a></span><span> </span><span class="annot"><span class="annottext">Decl Symbol
</span><a href="#local-6989586621680729520"><span class="hs-identifier hs-var">decl2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-226"></span><span>
</span><span id="line-227"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#getDeclComponent"><span class="hs-identifier hs-type">getDeclComponent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Decl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><a href="Unison.Parser.Ann.html#Ann"><span class="hs-identifier hs-type">Ann</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-228"></span><span id="getDeclComponent"><span class="annot"><span class="annottext">getDeclComponent :: Hash -&gt; Transaction (Maybe [Decl Symbol Ann])
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getDeclComponent"><span class="hs-identifier hs-var hs-var">getDeclComponent</span></a></span></span><span> </span><span id="local-6989586621680729516"><span class="annot"><span class="annottext">h1 :: Hash
</span><a href="#local-6989586621680729516"><span class="hs-identifier hs-var">h1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Hash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#hash1to2"><span class="hs-identifier hs-var">Cv.hash1to2</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621680729515"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729515"><span class="hs-identifier hs-var">h2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-229"></span><span>  </span><span class="annot"><span class="annottext">MaybeT Transaction [Decl Symbol Ann]
-&gt; Transaction (Maybe [Decl Symbol Ann])
forall (m :: * -&gt; *) a. MaybeT m a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var hs-var">runMaybeT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-230"></span><span>    </span><span id="local-6989586621680729514"><span class="annot"><span class="annottext">[Decl Symbol]
</span><a href="#local-6989586621680729514"><span class="hs-identifier hs-var">decl2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Hash -&gt; MaybeT Transaction [Decl Symbol]
</span><span class="hs-identifier hs-var">Ops.loadDeclComponent</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729515"><span class="hs-identifier hs-var">h2</span></a></span><span>
</span><span id="line-231"></span><span>    </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Decl Symbol -&gt; Decl Symbol Ann)
-&gt; [Decl Symbol] -&gt; [Decl Symbol Ann]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Decl Symbol -&gt; Decl Symbol Ann
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#decl2to1"><span class="hs-identifier hs-var">Cv.decl2to1</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729516"><span class="hs-identifier hs-var">h1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Decl Symbol]
</span><a href="#local-6989586621680729514"><span class="hs-identifier hs-var">decl2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-232"></span><span>
</span><span id="line-233"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#getCycleLength"><span class="hs-identifier hs-type">getCycleLength</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.CycleSize</span></span><span class="hs-special">)</span><span>
</span><span id="line-234"></span><span id="getCycleLength"><span class="annot"><span class="annottext">getCycleLength :: Hash -&gt; Transaction (Maybe Word64)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getCycleLength"><span class="hs-identifier hs-var hs-var">getCycleLength</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Hash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#hash1to2"><span class="hs-identifier hs-var">Cv.hash1to2</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621680729510"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729510"><span class="hs-identifier hs-var">h2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-235"></span><span>  </span><span class="annot"><span class="annottext">Hash -&gt; Transaction (Maybe Word64)
</span><span class="hs-identifier hs-var">Ops.getCycleLen</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729510"><span class="hs-identifier hs-var">h2</span></a></span><span>
</span><span id="line-236"></span><span>
</span><span id="line-237"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#putTerm"><span class="hs-identifier hs-type">putTerm</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-238"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#TermBufferEntry"><span class="hs-identifier hs-type">TermBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-239"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#DeclBufferEntry"><span class="hs-identifier hs-type">DeclBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-240"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-241"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><a href="Unison.Parser.Ann.html#Ann"><span class="hs-identifier hs-type">Ann</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-242"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><a href="Unison.Parser.Ann.html#Ann"><span class="hs-identifier hs-type">Ann</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-243"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-244"></span><span id="putTerm"><span class="annot"><span class="annottext">putTerm :: TVar (Map Hash TermBufferEntry)
-&gt; TVar (Map Hash DeclBufferEntry)
-&gt; Id
-&gt; Term Symbol Ann
-&gt; Type Symbol Ann
-&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putTerm"><span class="hs-identifier hs-var hs-var">putTerm</span></a></span></span><span> </span><span id="local-6989586621680729507"><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680729507"><span class="hs-identifier hs-var">termBuffer</span></a></span></span><span> </span><span id="local-6989586621680729506"><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
</span><a href="#local-6989586621680729506"><span class="hs-identifier hs-var">declBuffer</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span id="local-6989586621680729505"><span class="annot"><span class="annottext">h :: Hash
</span><a href="#local-6989586621680729505"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Hash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#hash1to2"><span class="hs-identifier hs-var">Cv.hash1to2</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621680729504"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729504"><span class="hs-identifier hs-var">h2</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680729503"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729503"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680729502"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680729502"><span class="hs-identifier hs-var">tm</span></a></span></span><span> </span><span id="local-6989586621680729501"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680729501"><span class="hs-identifier hs-var">tp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-245"></span><span>  </span><span class="annot"><span class="annottext">Transaction Bool -&gt; Transaction () -&gt; Transaction ()
forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m () -&gt; m ()
</span><span class="hs-identifier hs-var">unlessM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Transaction Bool
</span><span class="hs-identifier hs-var">Ops.objectExistsForHash</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729504"><span class="hs-identifier hs-var">h2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-246"></span><span>    </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-type">BufferEntry</span></a></span><span> </span><span id="local-6989586621680729500"><span class="annot"><span class="annottext">Maybe Word64
</span><a href="#local-6989586621680729500"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span id="local-6989586621680729499"><span class="annot"><span class="annottext">Map Word64 (Term Symbol Ann, Type Symbol Ann)
</span><a href="#local-6989586621680729499"><span class="hs-identifier hs-var">comp</span></a></span></span><span> </span><span id="local-6989586621680729498"><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680729498"><span class="hs-identifier hs-var">missing</span></a></span></span><span> </span><span id="local-6989586621680729497"><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680729497"><span class="hs-identifier hs-var">waiting</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO TermBufferEntry -&gt; Transaction TermBufferEntry
forall a. IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry) -&gt; Hash -&gt; IO TermBufferEntry
forall a.
TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; IO (BufferEntry a)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getBuffer"><span class="hs-identifier hs-var">getBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680729507"><span class="hs-identifier hs-var">termBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729505"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680729496"><span class="annot"><span class="annottext">termDependencies :: [Reference]
</span><a href="#local-6989586621680729496"><span class="hs-identifier hs-var hs-var">termDependencies</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set Reference -&gt; [Reference]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">(Set Reference -&gt; [Reference]) -&gt; Set Reference -&gt; [Reference]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; Set Reference
forall v vt at ap a.
(Ord v, Ord vt) =&gt;
Term2 vt at ap v a -&gt; Set Reference
</span><span class="hs-identifier hs-var">Term.termDependencies</span></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680729502"><span class="hs-identifier hs-var">tm</span></a></span><span>
</span><span id="line-248"></span><span>    </span><span class="hs-comment">-- update the component target size if we encounter any higher self-references</span><span>
</span><span id="line-249"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680729494"><span class="annot"><span class="annottext">size' :: Maybe Word64
</span><a href="#local-6989586621680729494"><span class="hs-identifier hs-var hs-var">size'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Word64 -&gt; Maybe Word64 -&gt; Maybe Word64
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="annot"><span class="annottext">Maybe Word64
</span><a href="#local-6989586621680729500"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; Maybe Word64
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; Maybe Word64) -&gt; Word64 -&gt; Maybe Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729492"><span class="hs-identifier hs-var">biggestSelfReference</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-251"></span><span>            </span><span id="local-6989586621680729492"><span class="annot"><span class="annottext">biggestSelfReference :: Word64
</span><a href="#local-6989586621680729492"><span class="hs-identifier hs-var hs-var">biggestSelfReference</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-252"></span><span>              </span><span class="annot"><span class="annottext">NonEmpty Word64 -&gt; Word64
forall a. Ord a =&gt; NonEmpty a -&gt; a
</span><span class="hs-identifier hs-var">maximum1</span></span><span> </span><span class="annot"><span class="annottext">(NonEmpty Word64 -&gt; Word64) -&gt; NonEmpty Word64 -&gt; Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-253"></span><span>                </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729503"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; [Word64] -&gt; NonEmpty Word64
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">:|</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729490"><span class="hs-identifier hs-var">i'</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Derived</span></span><span> </span><span id="local-6989586621680729488"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729488"><span class="hs-identifier hs-var">h'</span></a></span></span><span> </span><span id="local-6989586621680729490"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729490"><span class="hs-identifier hs-var">i'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Reference]
</span><a href="#local-6989586621680729496"><span class="hs-identifier hs-var">termDependencies</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729505"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Hash -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729488"><span class="hs-identifier hs-var">h'</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-254"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680729487"><span class="annot"><span class="annottext">comp' :: Map Word64 (Term Symbol Ann, Type Symbol Ann)
</span><a href="#local-6989586621680729487"><span class="hs-identifier hs-var hs-var">comp'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64
-&gt; (Term Symbol Ann, Type Symbol Ann)
-&gt; Map Word64 (Term Symbol Ann, Type Symbol Ann)
-&gt; Map Word64 (Term Symbol Ann, Type Symbol Ann)
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insert</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729503"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680729502"><span class="hs-identifier hs-var">tm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680729501"><span class="hs-identifier hs-var">tp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Word64 (Term Symbol Ann, Type Symbol Ann)
</span><a href="#local-6989586621680729499"><span class="hs-identifier hs-var">comp</span></a></span><span>
</span><span id="line-255"></span><span>    </span><span class="hs-comment">-- for the component element that's been passed in, add its dependencies to missing'</span><span>
</span><span id="line-256"></span><span>    </span><span id="local-6989586621680729486"><span class="annot"><span class="annottext">[Hash]
</span><a href="#local-6989586621680729486"><span class="hs-identifier hs-var">missingTerms'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-257"></span><span>      </span><span class="annot"><span class="annottext">(Hash -&gt; Transaction Bool) -&gt; [Hash] -&gt; Transaction [Hash]
forall (m :: * -&gt; *) a.
Applicative m =&gt;
(a -&gt; m Bool) -&gt; [a] -&gt; m [a]
</span><span class="hs-identifier hs-var">filterM</span></span><span>
</span><span id="line-258"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Transaction Bool -&gt; Transaction Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Transaction Bool -&gt; Transaction Bool)
-&gt; (Hash -&gt; Transaction Bool) -&gt; Hash -&gt; Transaction Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Transaction Bool
</span><span class="hs-identifier hs-var">Ops.objectExistsForHash</span></span><span> </span><span class="annot"><span class="annottext">(Hash -&gt; Transaction Bool)
-&gt; (Hash -&gt; Hash) -&gt; Hash -&gt; Transaction Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Hash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#hash1to2"><span class="hs-identifier hs-var">Cv.hash1to2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-259"></span><span>        </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729485"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Derived</span></span><span> </span><span id="local-6989586621680729485"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729485"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621680729484"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729484"><span class="hs-identifier hs-var">_i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Reference]
</span><a href="#local-6989586621680729496"><span class="hs-identifier hs-var">termDependencies</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-260"></span><span>    </span><span id="local-6989586621680729483"><span class="annot"><span class="annottext">[Hash]
</span><a href="#local-6989586621680729483"><span class="hs-identifier hs-var">missingTypes'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-261"></span><span>      </span><span class="annot"><span class="annottext">(Hash -&gt; Transaction Bool) -&gt; [Hash] -&gt; Transaction [Hash]
forall (m :: * -&gt; *) a.
Applicative m =&gt;
(a -&gt; m Bool) -&gt; [a] -&gt; m [a]
</span><span class="hs-identifier hs-var">filterM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Transaction Bool -&gt; Transaction Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Transaction Bool -&gt; Transaction Bool)
-&gt; (Hash -&gt; Transaction Bool) -&gt; Hash -&gt; Transaction Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Transaction Bool
</span><span class="hs-identifier hs-var">Ops.objectExistsForHash</span></span><span> </span><span class="annot"><span class="annottext">(Hash -&gt; Transaction Bool)
-&gt; (Hash -&gt; Hash) -&gt; Hash -&gt; Transaction Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Hash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#hash1to2"><span class="hs-identifier hs-var">Cv.hash1to2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Hash] -&gt; Transaction [Hash]) -&gt; [Hash] -&gt; Transaction [Hash]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-262"></span><span>        </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729482"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Derived</span></span><span> </span><span id="local-6989586621680729482"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729482"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621680729481"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729481"><span class="hs-identifier hs-var">_i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Set Reference -&gt; [Reference]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">(Set Reference -&gt; [Reference]) -&gt; Set Reference -&gt; [Reference]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; Set Reference
forall v vt at ap a.
(Ord v, Ord vt) =&gt;
Term2 vt at ap v a -&gt; Set Reference
</span><span class="hs-identifier hs-var">Term.typeDependencies</span></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680729502"><span class="hs-identifier hs-var">tm</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-263"></span><span>          </span><span class="annot"><span class="annottext">[Hash] -&gt; [Hash] -&gt; [Hash]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729479"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Derived</span></span><span> </span><span id="local-6989586621680729479"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729479"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621680729478"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729478"><span class="hs-identifier hs-var">_i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Set Reference -&gt; [Reference]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">(Set Reference -&gt; [Reference]) -&gt; Set Reference -&gt; [Reference]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann -&gt; Set Reference
forall v a. Ord v =&gt; Type v a -&gt; Set Reference
</span><span class="hs-identifier hs-var">Type.dependencies</span></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680729501"><span class="hs-identifier hs-var">tp</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-264"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680729476"><span class="annot"><span class="annottext">missing' :: Set Hash
</span><a href="#local-6989586621680729476"><span class="hs-identifier hs-var hs-var">missing'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680729498"><span class="hs-identifier hs-var">missing</span></a></span><span> </span><span class="annot"><span class="annottext">Set Hash -&gt; Set Hash -&gt; Set Hash
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Hash] -&gt; Set Hash
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Hash]
</span><a href="#local-6989586621680729486"><span class="hs-identifier hs-var">missingTerms'</span></a></span><span> </span><span class="annot"><span class="annottext">[Hash] -&gt; [Hash] -&gt; [Hash]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Hash]
</span><a href="#local-6989586621680729483"><span class="hs-identifier hs-var">missingTypes'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-265"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; Transaction ()
forall a. IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-266"></span><span>      </span><span class="hs-comment">-- notify each of the dependencies that h depends on them.</span><span>
</span><span id="line-267"></span><span>      </span><span class="annot"><span class="annottext">(Hash -&gt; IO ()) -&gt; [Hash] -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; TVar (Map Hash TermBufferEntry) -&gt; Hash -&gt; IO ()
forall a. Hash -&gt; TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; IO ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#addBufferDependent"><span class="hs-identifier hs-var">addBufferDependent</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729505"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680729507"><span class="hs-identifier hs-var">termBuffer</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Hash]
</span><a href="#local-6989586621680729486"><span class="hs-identifier hs-var">missingTerms'</span></a></span><span>
</span><span id="line-268"></span><span>      </span><span class="annot"><span class="annottext">(Hash -&gt; IO ()) -&gt; [Hash] -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; TVar (Map Hash DeclBufferEntry) -&gt; Hash -&gt; IO ()
forall a. Hash -&gt; TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; IO ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#addBufferDependent"><span class="hs-identifier hs-var">addBufferDependent</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729505"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
</span><a href="#local-6989586621680729506"><span class="hs-identifier hs-var">declBuffer</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Hash]
</span><a href="#local-6989586621680729483"><span class="hs-identifier hs-var">missingTypes'</span></a></span><span>
</span><span id="line-269"></span><span>      </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry) -&gt; Hash -&gt; TermBufferEntry -&gt; IO ()
forall a.
TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; BufferEntry a -&gt; IO ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putBuffer"><span class="hs-identifier hs-var">putBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680729507"><span class="hs-identifier hs-var">termBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729505"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Word64
-&gt; Map Word64 (Term Symbol Ann, Type Symbol Ann)
-&gt; Set Hash
-&gt; Set Hash
-&gt; TermBufferEntry
forall a.
Maybe Word64
-&gt; Map Word64 a -&gt; Set Hash -&gt; Set Hash -&gt; BufferEntry a
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-var">BufferEntry</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Word64
</span><a href="#local-6989586621680729494"><span class="hs-identifier hs-var">size'</span></a></span><span> </span><span class="annot"><span class="annottext">Map Word64 (Term Symbol Ann, Type Symbol Ann)
</span><a href="#local-6989586621680729487"><span class="hs-identifier hs-var">comp'</span></a></span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680729476"><span class="hs-identifier hs-var">missing'</span></a></span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680729497"><span class="hs-identifier hs-var">waiting</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>    </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry) -&gt; Hash -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#tryFlushTermBuffer"><span class="hs-identifier hs-var">tryFlushTermBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680729507"><span class="hs-identifier hs-var">termBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729505"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-271"></span><span>
</span><span id="line-272"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#tryFlushTermBuffer"><span class="hs-identifier hs-type">tryFlushTermBuffer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#TermBufferEntry"><span class="hs-identifier hs-type">TermBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-273"></span><span id="tryFlushTermBuffer"><span class="annot"><span class="annottext">tryFlushTermBuffer :: TVar (Map Hash TermBufferEntry) -&gt; Hash -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#tryFlushTermBuffer"><span class="hs-identifier hs-var hs-var">tryFlushTermBuffer</span></a></span></span><span> </span><span id="local-6989586621680729474"><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680729474"><span class="hs-identifier hs-var">termBuffer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-274"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680729473"><span class="annot"><span class="annottext">loop :: Hash -&gt; Transaction ()
</span><a href="#local-6989586621680729473"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span id="local-6989586621680729472"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729472"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-275"></span><span>        </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
-&gt; (Hash -&gt; [(Term Symbol Ann, Type Symbol Ann)] -&gt; Transaction ())
-&gt; (Hash -&gt; Transaction ())
-&gt; Hash
-&gt; Transaction ()
forall a.
Show a =&gt;
TVar (Map Hash (BufferEntry a))
-&gt; (Hash -&gt; [a] -&gt; Transaction ())
-&gt; (Hash -&gt; Transaction ())
-&gt; Hash
-&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#tryFlushBuffer"><span class="hs-identifier hs-var">tryFlushBuffer</span></a></span><span>
</span><span id="line-276"></span><span>          </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680729474"><span class="hs-identifier hs-var">termBuffer</span></a></span><span>
</span><span id="line-277"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680729471"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729471"><span class="hs-identifier hs-var">h2</span></a></span></span><span> </span><span id="local-6989586621680729470"><span class="annot"><span class="annottext">[(Term Symbol Ann, Type Symbol Ann)]
</span><a href="#local-6989586621680729470"><span class="hs-identifier hs-var">component</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-278"></span><span>              </span><span class="annot"><span class="annottext">Transaction ObjectId -&gt; Transaction ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(Transaction ObjectId -&gt; Transaction ())
-&gt; Transaction ObjectId -&gt; Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-279"></span><span>                </span><span class="annot"><span class="annottext">Maybe ByteString
-&gt; Hash -&gt; [(Term Symbol, Type Symbol)] -&gt; Transaction ObjectId
</span><span class="hs-identifier hs-var">saveTermComponent</span></span><span>
</span><span id="line-280"></span><span>                  </span><span class="annot"><span class="annottext">Maybe ByteString
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-281"></span><span>                  </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729471"><span class="hs-identifier hs-var">h2</span></a></span><span>
</span><span id="line-282"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Term Symbol Ann, Type Symbol Ann) -&gt; (Term Symbol, Type Symbol))
-&gt; [(Term Symbol Ann, Type Symbol Ann)]
-&gt; [(Term Symbol, Type Symbol)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Term Symbol Ann -&gt; Term Symbol)
-&gt; (Type Symbol Ann -&gt; Type Symbol)
-&gt; (Term Symbol Ann, Type Symbol Ann)
-&gt; (Term Symbol, Type Symbol)
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><span class="hs-identifier hs-var">bimap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Term Symbol Ann -&gt; Term Symbol
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#term1to2"><span class="hs-identifier hs-var">Cv.term1to2</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729472"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann -&gt; Type Symbol
forall a. Type Symbol a -&gt; Type Symbol
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#ttype1to2"><span class="hs-identifier hs-var">Cv.ttype1to2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Term Symbol Ann, Type Symbol Ann)]
</span><a href="#local-6989586621680729470"><span class="hs-identifier hs-var">component</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-284"></span><span>          </span><span class="annot"><span class="annottext">Hash -&gt; Transaction ()
</span><a href="#local-6989586621680729473"><span class="hs-identifier hs-var">loop</span></a></span><span>
</span><span id="line-285"></span><span>          </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729472"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-286"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Transaction ()
</span><a href="#local-6989586621680729473"><span class="hs-identifier hs-var">loop</span></a></span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#addDeclComponentTypeIndex"><span class="hs-identifier hs-type">addDeclComponentTypeIndex</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ObjectId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><a href="Unison.Parser.Ann.html#Ann"><span class="hs-identifier hs-type">Ann</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-289"></span><span id="addDeclComponentTypeIndex"><span class="annot"><span class="annottext">addDeclComponentTypeIndex :: ObjectId -&gt; [[Type Symbol Ann]] -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#addDeclComponentTypeIndex"><span class="hs-identifier hs-var hs-var">addDeclComponentTypeIndex</span></a></span></span><span> </span><span id="local-6989586621680729465"><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680729465"><span class="hs-identifier hs-var">oId</span></a></span></span><span> </span><span id="local-6989586621680729464"><span class="annot"><span class="annottext">[[Type Symbol Ann]]
</span><a href="#local-6989586621680729464"><span class="hs-identifier hs-var">ctorss</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-290"></span><span>  </span><span class="annot"><span class="annottext">[([Type Symbol Ann], Word64)]
-&gt; (([Type Symbol Ann], Word64) -&gt; Transaction ())
-&gt; Transaction ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[[Type Symbol Ann]]
</span><a href="#local-6989586621680729464"><span class="hs-identifier hs-var">ctorss</span></a></span><span> </span><span class="annot"><span class="annottext">[[Type Symbol Ann]] -&gt; [Word64] -&gt; [([Type Symbol Ann], Word64)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-operator hs-var">`zip`</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680729462"><span class="annot"><span class="annottext">[Type Symbol Ann]
</span><a href="#local-6989586621680729462"><span class="hs-identifier hs-var">ctors</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680729461"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729461"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-291"></span><span>    </span><span class="annot"><span class="annottext">[(Type Symbol Ann, Word64)]
-&gt; ((Type Symbol Ann, Word64) -&gt; Transaction ()) -&gt; Transaction ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type Symbol Ann]
</span><a href="#local-6989586621680729462"><span class="hs-identifier hs-var">ctors</span></a></span><span> </span><span class="annot"><span class="annottext">[Type Symbol Ann] -&gt; [Word64] -&gt; [(Type Symbol Ann, Word64)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-operator hs-var">`zip`</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680729460"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680729460"><span class="hs-identifier hs-var">tp</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680729459"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729459"><span class="hs-identifier hs-var">j</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-292"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680729458"><span class="annot"><span class="annottext">self :: Id' hTm ObjectId
</span><a href="#local-6989586621680729458"><span class="hs-identifier hs-var hs-var">self</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id' ObjectId -&gt; Word64 -&gt; Id' hTm ObjectId
forall hTm hTp. Id' hTp -&gt; Word64 -&gt; Id' hTm hTp
</span><span class="hs-identifier hs-var">C.Referent.ConId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ObjectId -&gt; Word64 -&gt; Id' ObjectId
forall h. h -&gt; Word64 -&gt; Id' h
</span><span class="hs-identifier hs-var">C.Reference.Id</span></span><span> </span><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680729465"><span class="hs-identifier hs-var">oId</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729461"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729459"><span class="hs-identifier hs-var">j</span></a></span><span>
</span><span id="line-293"></span><span>          </span><span id="local-6989586621680729456"><span class="annot"><span class="annottext">typeForIndexing :: Reference
</span><a href="#local-6989586621680729456"><span class="hs-identifier hs-var hs-var">typeForIndexing</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann -&gt; Reference
forall v a. Var v =&gt; Type v a -&gt; Reference
</span><a href="Unison.Hashing.V2.Convert.html#typeToReference"><span class="hs-identifier hs-var">Hashing.typeToReference</span></a></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680729460"><span class="hs-identifier hs-var">tp</span></a></span><span>
</span><span id="line-294"></span><span>          </span><span id="local-6989586621680729454"><span class="annot"><span class="annottext">typeMentionsForIndexing :: Set Reference
</span><a href="#local-6989586621680729454"><span class="hs-identifier hs-var hs-var">typeMentionsForIndexing</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann -&gt; Set Reference
forall v a. Var v =&gt; Type v a -&gt; Set Reference
</span><a href="Unison.Hashing.V2.Convert.html#typeToReferenceMentions"><span class="hs-identifier hs-var">Hashing.typeToReferenceMentions</span></a></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680729460"><span class="hs-identifier hs-var">tp</span></a></span><span>
</span><span id="line-295"></span><span>      </span><span class="annot"><span class="annottext">Id -&gt; Reference -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Ops.addTypeToIndexForTerm</span></span><span> </span><span class="annot"><span class="annottext">Id
forall hTm. Id' hTm ObjectId
</span><a href="#local-6989586621680729458"><span class="hs-identifier hs-var">self</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reference -&gt; Reference
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#reference1to2"><span class="hs-identifier hs-var">Cv.reference1to2</span></a></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621680729456"><span class="hs-identifier hs-var">typeForIndexing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-296"></span><span>      </span><span class="annot"><span class="annottext">Id -&gt; Set Reference -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Ops.addTypeMentionsToIndexForTerm</span></span><span> </span><span class="annot"><span class="annottext">Id
forall hTm. Id' hTm ObjectId
</span><a href="#local-6989586621680729458"><span class="hs-identifier hs-var">self</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Reference -&gt; Reference) -&gt; Set Reference -&gt; Set Reference
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">Set.map</span></span><span> </span><span class="annot"><span class="annottext">Reference -&gt; Reference
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#reference1to2"><span class="hs-identifier hs-var">Cv.reference1to2</span></a></span><span> </span><span class="annot"><span class="annottext">Set Reference
</span><a href="#local-6989586621680729454"><span class="hs-identifier hs-var">typeMentionsForIndexing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#putTypeDeclaration"><span class="hs-identifier hs-type">putTypeDeclaration</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-299"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#TermBufferEntry"><span class="hs-identifier hs-type">TermBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-300"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#DeclBufferEntry"><span class="hs-identifier hs-type">DeclBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-301"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-302"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Decl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><a href="Unison.Parser.Ann.html#Ann"><span class="hs-identifier hs-type">Ann</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-303"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span id="putTypeDeclaration"><span class="annot"><span class="annottext">putTypeDeclaration :: TVar (Map Hash TermBufferEntry)
-&gt; TVar (Map Hash DeclBufferEntry)
-&gt; Id
-&gt; Decl Symbol Ann
-&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putTypeDeclaration"><span class="hs-identifier hs-var hs-var">putTypeDeclaration</span></a></span></span><span> </span><span id="local-6989586621680729447"><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680729447"><span class="hs-identifier hs-var">termBuffer</span></a></span></span><span> </span><span id="local-6989586621680729446"><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
</span><a href="#local-6989586621680729446"><span class="hs-identifier hs-var">declBuffer</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span id="local-6989586621680729445"><span class="annot"><span class="annottext">h :: Hash
</span><a href="#local-6989586621680729445"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Hash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#hash1to2"><span class="hs-identifier hs-var">Cv.hash1to2</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621680729444"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729444"><span class="hs-identifier hs-var">h2</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680729443"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729443"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680729442"><span class="annot"><span class="annottext">Decl Symbol Ann
</span><a href="#local-6989586621680729442"><span class="hs-identifier hs-var">decl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-305"></span><span>  </span><span class="annot"><span class="annottext">Transaction Bool -&gt; Transaction () -&gt; Transaction ()
forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m () -&gt; m ()
</span><span class="hs-identifier hs-var">unlessM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Transaction Bool
</span><span class="hs-identifier hs-var">Ops.objectExistsForHash</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729444"><span class="hs-identifier hs-var">h2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-306"></span><span>    </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-type">BufferEntry</span></a></span><span> </span><span id="local-6989586621680729441"><span class="annot"><span class="annottext">Maybe Word64
</span><a href="#local-6989586621680729441"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span id="local-6989586621680729440"><span class="annot"><span class="annottext">Map Word64 (Decl Symbol Ann)
</span><a href="#local-6989586621680729440"><span class="hs-identifier hs-var">comp</span></a></span></span><span> </span><span id="local-6989586621680729439"><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680729439"><span class="hs-identifier hs-var">missing</span></a></span></span><span> </span><span id="local-6989586621680729438"><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680729438"><span class="hs-identifier hs-var">waiting</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO DeclBufferEntry -&gt; Transaction DeclBufferEntry
forall a. IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry) -&gt; Hash -&gt; IO DeclBufferEntry
forall a.
TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; IO (BufferEntry a)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getBuffer"><span class="hs-identifier hs-var">getBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
</span><a href="#local-6989586621680729446"><span class="hs-identifier hs-var">declBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729445"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-307"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680729437"><span class="annot"><span class="annottext">declDependencies :: [Reference]
</span><a href="#local-6989586621680729437"><span class="hs-identifier hs-var hs-var">declDependencies</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set Reference -&gt; [Reference]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">(Set Reference -&gt; [Reference]) -&gt; Set Reference -&gt; [Reference]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Decl Symbol Ann -&gt; Set Reference
forall v a. Ord v =&gt; Decl v a -&gt; Set Reference
</span><span class="hs-identifier hs-var">Decl.declDependencies</span></span><span> </span><span class="annot"><span class="annottext">Decl Symbol Ann
</span><a href="#local-6989586621680729442"><span class="hs-identifier hs-var">decl</span></a></span><span>
</span><span id="line-308"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680729435"><span class="annot"><span class="annottext">size' :: Maybe Word64
</span><a href="#local-6989586621680729435"><span class="hs-identifier hs-var hs-var">size'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Word64 -&gt; Maybe Word64 -&gt; Maybe Word64
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="annot"><span class="annottext">Maybe Word64
</span><a href="#local-6989586621680729441"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; Maybe Word64
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; Maybe Word64) -&gt; Word64 -&gt; Maybe Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729434"><span class="hs-identifier hs-var">biggestSelfReference</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-309"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-310"></span><span>            </span><span id="local-6989586621680729434"><span class="annot"><span class="annottext">biggestSelfReference :: Word64
</span><a href="#local-6989586621680729434"><span class="hs-identifier hs-var hs-var">biggestSelfReference</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-311"></span><span>              </span><span class="annot"><span class="annottext">NonEmpty Word64 -&gt; Word64
forall a. Ord a =&gt; NonEmpty a -&gt; a
</span><span class="hs-identifier hs-var">maximum1</span></span><span> </span><span class="annot"><span class="annottext">(NonEmpty Word64 -&gt; Word64) -&gt; NonEmpty Word64 -&gt; Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-312"></span><span>                </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729443"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; [Word64] -&gt; NonEmpty Word64
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">:|</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729433"><span class="hs-identifier hs-var">i'</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Derived</span></span><span> </span><span id="local-6989586621680729432"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729432"><span class="hs-identifier hs-var">h'</span></a></span></span><span> </span><span id="local-6989586621680729433"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729433"><span class="hs-identifier hs-var">i'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Reference]
</span><a href="#local-6989586621680729437"><span class="hs-identifier hs-var">declDependencies</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729445"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Hash -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729432"><span class="hs-identifier hs-var">h'</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-313"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680729431"><span class="annot"><span class="annottext">comp' :: Map Word64 (Decl Symbol Ann)
</span><a href="#local-6989586621680729431"><span class="hs-identifier hs-var hs-var">comp'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64
-&gt; Decl Symbol Ann
-&gt; Map Word64 (Decl Symbol Ann)
-&gt; Map Word64 (Decl Symbol Ann)
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insert</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729443"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Decl Symbol Ann
</span><a href="#local-6989586621680729442"><span class="hs-identifier hs-var">decl</span></a></span><span> </span><span class="annot"><span class="annottext">Map Word64 (Decl Symbol Ann)
</span><a href="#local-6989586621680729440"><span class="hs-identifier hs-var">comp</span></a></span><span>
</span><span id="line-314"></span><span>    </span><span id="local-6989586621680729430"><span class="annot"><span class="annottext">[Hash]
</span><a href="#local-6989586621680729430"><span class="hs-identifier hs-var">moreMissing</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-315"></span><span>      </span><span class="annot"><span class="annottext">(Hash -&gt; Transaction Bool) -&gt; [Hash] -&gt; Transaction [Hash]
forall (m :: * -&gt; *) a.
Applicative m =&gt;
(a -&gt; m Bool) -&gt; [a] -&gt; m [a]
</span><span class="hs-identifier hs-var">filterM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Transaction Bool -&gt; Transaction Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Transaction Bool -&gt; Transaction Bool)
-&gt; (Hash -&gt; Transaction Bool) -&gt; Hash -&gt; Transaction Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Transaction Bool
</span><span class="hs-identifier hs-var">Ops.objectExistsForHash</span></span><span> </span><span class="annot"><span class="annottext">(Hash -&gt; Transaction Bool)
-&gt; (Hash -&gt; Hash) -&gt; Hash -&gt; Transaction Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Hash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#hash1to2"><span class="hs-identifier hs-var">Cv.hash1to2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Hash] -&gt; Transaction [Hash]) -&gt; [Hash] -&gt; Transaction [Hash]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-316"></span><span>        </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729429"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Derived</span></span><span> </span><span id="local-6989586621680729429"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729429"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621680729428"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729428"><span class="hs-identifier hs-var">_i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Reference]
</span><a href="#local-6989586621680729437"><span class="hs-identifier hs-var">declDependencies</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-317"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680729427"><span class="annot"><span class="annottext">missing' :: Set Hash
</span><a href="#local-6989586621680729427"><span class="hs-identifier hs-var hs-var">missing'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680729439"><span class="hs-identifier hs-var">missing</span></a></span><span> </span><span class="annot"><span class="annottext">Set Hash -&gt; Set Hash -&gt; Set Hash
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Hash] -&gt; Set Hash
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="annot"><span class="annottext">[Hash]
</span><a href="#local-6989586621680729430"><span class="hs-identifier hs-var">moreMissing</span></a></span><span>
</span><span id="line-318"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; Transaction ()
forall a. IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-319"></span><span>      </span><span class="annot"><span class="annottext">(Hash -&gt; IO ()) -&gt; [Hash] -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; TVar (Map Hash DeclBufferEntry) -&gt; Hash -&gt; IO ()
forall a. Hash -&gt; TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; IO ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#addBufferDependent"><span class="hs-identifier hs-var">addBufferDependent</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729445"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
</span><a href="#local-6989586621680729446"><span class="hs-identifier hs-var">declBuffer</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Hash]
</span><a href="#local-6989586621680729430"><span class="hs-identifier hs-var">moreMissing</span></a></span><span>
</span><span id="line-320"></span><span>      </span><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry) -&gt; Hash -&gt; DeclBufferEntry -&gt; IO ()
forall a.
TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; BufferEntry a -&gt; IO ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putBuffer"><span class="hs-identifier hs-var">putBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
</span><a href="#local-6989586621680729446"><span class="hs-identifier hs-var">declBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729445"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Word64
-&gt; Map Word64 (Decl Symbol Ann)
-&gt; Set Hash
-&gt; Set Hash
-&gt; DeclBufferEntry
forall a.
Maybe Word64
-&gt; Map Word64 a -&gt; Set Hash -&gt; Set Hash -&gt; BufferEntry a
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-var">BufferEntry</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Word64
</span><a href="#local-6989586621680729435"><span class="hs-identifier hs-var">size'</span></a></span><span> </span><span class="annot"><span class="annottext">Map Word64 (Decl Symbol Ann)
</span><a href="#local-6989586621680729431"><span class="hs-identifier hs-var">comp'</span></a></span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680729427"><span class="hs-identifier hs-var">missing'</span></a></span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680729438"><span class="hs-identifier hs-var">waiting</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-321"></span><span>    </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
-&gt; TVar (Map Hash DeclBufferEntry) -&gt; Hash -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#tryFlushDeclBuffer"><span class="hs-identifier hs-var">tryFlushDeclBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680729447"><span class="hs-identifier hs-var">termBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
</span><a href="#local-6989586621680729446"><span class="hs-identifier hs-var">declBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729445"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-322"></span><span>
</span><span id="line-323"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#tryFlushDeclBuffer"><span class="hs-identifier hs-type">tryFlushDeclBuffer</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-324"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#TermBufferEntry"><span class="hs-identifier hs-type">TermBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-325"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#DeclBufferEntry"><span class="hs-identifier hs-type">DeclBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-326"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-327"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-328"></span><span id="tryFlushDeclBuffer"><span class="annot"><span class="annottext">tryFlushDeclBuffer :: TVar (Map Hash TermBufferEntry)
-&gt; TVar (Map Hash DeclBufferEntry) -&gt; Hash -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#tryFlushDeclBuffer"><span class="hs-identifier hs-var hs-var">tryFlushDeclBuffer</span></a></span></span><span> </span><span id="local-6989586621680729425"><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680729425"><span class="hs-identifier hs-var">termBuffer</span></a></span></span><span> </span><span id="local-6989586621680729424"><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
</span><a href="#local-6989586621680729424"><span class="hs-identifier hs-var">declBuffer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-329"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680729423"><span class="annot"><span class="annottext">loop :: Hash -&gt; Transaction ()
</span><a href="#local-6989586621680729423"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span id="local-6989586621680729422"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729422"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-330"></span><span>        </span><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
-&gt; (Hash -&gt; [Decl Symbol Ann] -&gt; Transaction ())
-&gt; (Hash -&gt; Transaction ())
-&gt; Hash
-&gt; Transaction ()
forall a.
Show a =&gt;
TVar (Map Hash (BufferEntry a))
-&gt; (Hash -&gt; [a] -&gt; Transaction ())
-&gt; (Hash -&gt; Transaction ())
-&gt; Hash
-&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#tryFlushBuffer"><span class="hs-identifier hs-var">tryFlushBuffer</span></a></span><span>
</span><span id="line-331"></span><span>          </span><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
</span><a href="#local-6989586621680729424"><span class="hs-identifier hs-var">declBuffer</span></a></span><span>
</span><span id="line-332"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680729421"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729421"><span class="hs-identifier hs-var">h2</span></a></span></span><span> </span><span id="local-6989586621680729420"><span class="annot"><span class="annottext">[Decl Symbol Ann]
</span><a href="#local-6989586621680729420"><span class="hs-identifier hs-var">component</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-333"></span><span>              </span><span class="annot"><span class="annottext">Transaction ObjectId -&gt; Transaction ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(Transaction ObjectId -&gt; Transaction ())
-&gt; Transaction ObjectId -&gt; Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-334"></span><span>                </span><span class="annot"><span class="annottext">Maybe ByteString -&gt; Hash -&gt; [Decl Symbol] -&gt; Transaction ObjectId
</span><span class="hs-identifier hs-var">saveDeclComponent</span></span><span>
</span><span id="line-335"></span><span>                  </span><span class="annot"><span class="annottext">Maybe ByteString
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-336"></span><span>                  </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729421"><span class="hs-identifier hs-var">h2</span></a></span><span>
</span><span id="line-337"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Decl Symbol Ann -&gt; Decl Symbol)
-&gt; [Decl Symbol Ann] -&gt; [Decl Symbol]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Decl Symbol Ann -&gt; Decl Symbol
forall a. Hash -&gt; Decl Symbol a -&gt; Decl Symbol
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#decl1to2"><span class="hs-identifier hs-var">Cv.decl1to2</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729422"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Decl Symbol Ann]
</span><a href="#local-6989586621680729420"><span class="hs-identifier hs-var">component</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-338"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-339"></span><span>          </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621680729418"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729418"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry) -&gt; Hash -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#tryFlushTermBuffer"><span class="hs-identifier hs-var">tryFlushTermBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680729425"><span class="hs-identifier hs-var">termBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729418"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Transaction () -&gt; Transaction () -&gt; Transaction ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Transaction ()
</span><a href="#local-6989586621680729423"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729418"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-340"></span><span>          </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729422"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-341"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Transaction ()
</span><a href="#local-6989586621680729423"><span class="hs-identifier hs-var">loop</span></a></span><span>
</span><span id="line-342"></span><span>
</span><span id="line-343"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#getRootBranch"><span class="hs-identifier hs-type">getRootBranch</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-344"></span><span>  </span><span class="hs-comment">-- | A 'getDeclType'-like lookup, possibly backed by a cache.</span><span>
</span><span id="line-345"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-346"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Sqlite.DataVersion</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Unison.Codebase.Branch.Type.html#Branch"><span class="hs-identifier hs-type">Branch</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-347"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.Branch.Type.html#Branch"><span class="hs-identifier hs-type">Branch</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span class="hs-special">)</span><span>
</span><span id="line-348"></span><span id="getRootBranch"><span class="annot"><span class="annottext">getRootBranch :: (Reference -&gt; Transaction ConstructorType)
-&gt; TVar (Maybe (DataVersion, Branch Transaction))
-&gt; Transaction (Branch Transaction)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getRootBranch"><span class="hs-identifier hs-var hs-var">getRootBranch</span></a></span></span><span> </span><span id="local-6989586621680729416"><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680729416"><span class="hs-identifier hs-var">doGetDeclType</span></a></span></span><span> </span><span id="local-6989586621680729415"><span class="annot"><span class="annottext">TVar (Maybe (DataVersion, Branch Transaction))
</span><a href="#local-6989586621680729415"><span class="hs-identifier hs-var">rootBranchCache</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-349"></span><span>  </span><span class="annot"><span class="annottext">IO (Maybe (DataVersion, Branch Transaction))
-&gt; Transaction (Maybe (DataVersion, Branch Transaction))
forall a. IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar (Maybe (DataVersion, Branch Transaction))
-&gt; IO (Maybe (DataVersion, Branch Transaction))
forall (m :: * -&gt; *) a. MonadIO m =&gt; TVar a -&gt; m a
</span><span class="hs-identifier hs-var">readTVarIO</span></span><span> </span><span class="annot"><span class="annottext">TVar (Maybe (DataVersion, Branch Transaction))
</span><a href="#local-6989586621680729415"><span class="hs-identifier hs-var">rootBranchCache</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Transaction (Maybe (DataVersion, Branch Transaction))
-&gt; (Maybe (DataVersion, Branch Transaction)
    -&gt; Transaction (Branch Transaction))
-&gt; Transaction (Branch Transaction)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-350"></span><span>    </span><span class="annot"><span class="annottext">Maybe (DataVersion, Branch Transaction)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Transaction (Branch Transaction)
</span><a href="#local-6989586621680729414"><span class="hs-identifier hs-var">forceReload</span></a></span><span>
</span><span id="line-351"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680729413"><span class="annot"><span class="annottext">DataVersion
</span><a href="#local-6989586621680729413"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680729412"><span class="annot"><span class="annottext">Branch Transaction
</span><a href="#local-6989586621680729412"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-352"></span><span>      </span><span class="hs-comment">-- check to see if root namespace hash has been externally modified</span><span>
</span><span id="line-353"></span><span>      </span><span class="hs-comment">-- and reload it if necessary</span><span>
</span><span id="line-354"></span><span>      </span><span id="local-6989586621680729411"><span class="annot"><span class="annottext">DataVersion
</span><a href="#local-6989586621680729411"><span class="hs-identifier hs-var">v'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Transaction DataVersion
</span><span class="hs-identifier hs-var">Sqlite.getDataVersion</span></span><span>
</span><span id="line-355"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">DataVersion
</span><a href="#local-6989586621680729413"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">DataVersion -&gt; DataVersion -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">DataVersion
</span><a href="#local-6989586621680729411"><span class="hs-identifier hs-var">v'</span></a></span><span>
</span><span id="line-356"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Branch Transaction -&gt; Transaction (Branch Transaction)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Branch Transaction
</span><a href="#local-6989586621680729412"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-357"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-358"></span><span>          </span><span id="local-6989586621680729409"><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621680729409"><span class="hs-identifier hs-var">newRootHash</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Transaction CausalHash
</span><span class="hs-identifier hs-var">Ops.expectRootCausalHash</span></span><span>
</span><span id="line-359"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Branch Transaction -&gt; CausalHash
forall (m :: * -&gt; *). Branch m -&gt; CausalHash
</span><a href="Unison.Codebase.Branch.Type.html#headHash"><span class="hs-identifier hs-var">Branch.headHash</span></a></span><span> </span><span class="annot"><span class="annottext">Branch Transaction
</span><a href="#local-6989586621680729412"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">CausalHash -&gt; CausalHash -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">CausalHash -&gt; CausalHash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#causalHash2to1"><span class="hs-identifier hs-var">Cv.causalHash2to1</span></a></span><span> </span><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621680729409"><span class="hs-identifier hs-var">newRootHash</span></a></span><span>
</span><span id="line-360"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Branch Transaction -&gt; Transaction (Branch Transaction)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Branch Transaction
</span><a href="#local-6989586621680729412"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-361"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-362"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; Transaction ()
forall (f :: * -&gt; *). Applicative f =&gt; String -&gt; f ()
</span><span class="hs-identifier hs-var">traceM</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Transaction ()) -&gt; String -&gt; Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;database was externally modified (&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">DataVersion -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">DataVersion
</span><a href="#local-6989586621680729413"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; -&gt; &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">DataVersion -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">DataVersion
</span><a href="#local-6989586621680729411"><span class="hs-identifier hs-var">v'</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;)&quot;</span></span><span>
</span><span id="line-363"></span><span>              </span><span class="annot"><span class="annottext">Transaction (Branch Transaction)
</span><a href="#local-6989586621680729414"><span class="hs-identifier hs-var">forceReload</span></a></span><span>
</span><span id="line-364"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-365"></span><span>    </span><span class="annot"><a href="#local-6989586621680729414"><span class="hs-identifier hs-type">forceReload</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.Branch.Type.html#Branch"><span class="hs-identifier hs-type">Branch</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span class="hs-special">)</span><span>
</span><span id="line-366"></span><span>    </span><span id="local-6989586621680729414"><span class="annot"><span class="annottext">forceReload :: Transaction (Branch Transaction)
</span><a href="#local-6989586621680729414"><span class="hs-identifier hs-var hs-var">forceReload</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-367"></span><span>      </span><span id="local-6989586621680729404"><span class="annot"><span class="annottext">Branch Transaction
</span><a href="#local-6989586621680729404"><span class="hs-identifier hs-var">branch1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Reference -&gt; Transaction ConstructorType)
-&gt; Transaction (Branch Transaction)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#uncachedLoadRootBranch"><span class="hs-identifier hs-var">uncachedLoadRootBranch</span></a></span><span> </span><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680729416"><span class="hs-identifier hs-var">doGetDeclType</span></a></span><span>
</span><span id="line-368"></span><span>      </span><span id="local-6989586621680729402"><span class="annot"><span class="annottext">DataVersion
</span><a href="#local-6989586621680729402"><span class="hs-identifier hs-var">ver</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Transaction DataVersion
</span><span class="hs-identifier hs-var">Sqlite.getDataVersion</span></span><span>
</span><span id="line-369"></span><span>      </span><span class="annot"><span class="annottext">IO () -&gt; Transaction ()
forall a. IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; STM a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar (Maybe (DataVersion, Branch Transaction))
-&gt; Maybe (DataVersion, Branch Transaction) -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar (Maybe (DataVersion, Branch Transaction))
</span><a href="#local-6989586621680729415"><span class="hs-identifier hs-var">rootBranchCache</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(DataVersion, Branch Transaction)
-&gt; Maybe (DataVersion, Branch Transaction)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataVersion
</span><a href="#local-6989586621680729402"><span class="hs-identifier hs-var">ver</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Branch Transaction
</span><a href="#local-6989586621680729404"><span class="hs-identifier hs-var">branch1</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-370"></span><span>      </span><span class="hs-identifier">pure</span><span> </span><span class="annot"><span class="annottext">Branch Transaction
</span><a href="#local-6989586621680729404"><span class="hs-identifier hs-var">branch1</span></a></span><span>
</span><span id="line-371"></span><span>
</span><span id="line-372"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#uncachedLoadRootBranch"><span class="hs-identifier hs-type">uncachedLoadRootBranch</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-373"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-374"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.Branch.Type.html#Branch"><span class="hs-identifier hs-type">Branch</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span class="hs-special">)</span><span>
</span><span id="line-375"></span><span id="uncachedLoadRootBranch"><span class="annot"><span class="annottext">uncachedLoadRootBranch :: (Reference -&gt; Transaction ConstructorType)
-&gt; Transaction (Branch Transaction)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#uncachedLoadRootBranch"><span class="hs-identifier hs-var hs-var">uncachedLoadRootBranch</span></a></span></span><span> </span><span id="local-6989586621680729400"><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680729400"><span class="hs-identifier hs-var">getDeclType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-376"></span><span>  </span><span id="local-6989586621680729399"><span class="annot"><span class="annottext">CausalBranch Transaction
</span><a href="#local-6989586621680729399"><span class="hs-identifier hs-var">causal2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Transaction (CausalBranch Transaction)
</span><span class="hs-identifier hs-var">Ops.expectRootCausal</span></span><span>
</span><span id="line-377"></span><span>  </span><span class="annot"><span class="annottext">(Reference -&gt; Transaction ConstructorType)
-&gt; CausalBranch Transaction -&gt; Transaction (Branch Transaction)
forall (m :: * -&gt; *).
Monad m =&gt;
(Reference -&gt; m ConstructorType) -&gt; CausalBranch m -&gt; m (Branch m)
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#causalbranch2to1"><span class="hs-identifier hs-var">Cv.causalbranch2to1</span></a></span><span> </span><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680729400"><span class="hs-identifier hs-var">getDeclType</span></a></span><span> </span><span class="annot"><span class="annottext">CausalBranch Transaction
</span><a href="#local-6989586621680729399"><span class="hs-identifier hs-var">causal2</span></a></span><span>
</span><span id="line-378"></span><span>
</span><span id="line-379"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#getRootBranchExists"><span class="hs-identifier hs-type">getRootBranchExists</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-380"></span><span id="getRootBranchExists"><span class="annot"><span class="annottext">getRootBranchExists :: Transaction Bool
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getRootBranchExists"><span class="hs-identifier hs-var hs-var">getRootBranchExists</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-381"></span><span>  </span><span class="annot"><span class="annottext">Maybe CausalHash -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe CausalHash -&gt; Bool)
-&gt; Transaction (Maybe CausalHash) -&gt; Transaction Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Transaction (Maybe CausalHash)
</span><span class="hs-identifier hs-var">Ops.loadRootCausalHash</span></span><span>
</span><span id="line-382"></span><span>
</span><span id="line-383"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#putRootBranch"><span class="hs-identifier hs-type">putRootBranch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Sqlite.DataVersion</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Unison.Codebase.Branch.Type.html#Branch"><span class="hs-identifier hs-type">Branch</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Codebase.Branch.Type.html#Branch"><span class="hs-identifier hs-type">Branch</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-384"></span><span id="putRootBranch"><span class="annot"><span class="annottext">putRootBranch :: TVar (Maybe (DataVersion, Branch Transaction))
-&gt; Branch Transaction -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putRootBranch"><span class="hs-identifier hs-var hs-var">putRootBranch</span></a></span></span><span> </span><span id="local-6989586621680729392"><span class="annot"><span class="annottext">TVar (Maybe (DataVersion, Branch Transaction))
</span><a href="#local-6989586621680729392"><span class="hs-identifier hs-var">rootBranchCache</span></a></span></span><span> </span><span id="local-6989586621680729391"><span class="annot"><span class="annottext">Branch Transaction
</span><a href="#local-6989586621680729391"><span class="hs-identifier hs-var">branch1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-385"></span><span>  </span><span class="hs-comment">-- todo: check to see if root namespace hash has been externally modified</span><span>
</span><span id="line-386"></span><span>  </span><span class="hs-comment">-- and do something (merge?) it if necessary. But for now, we just overwrite it.</span><span>
</span><span id="line-387"></span><span>  </span><span class="annot"><span class="annottext">Transaction (BranchObjectId, CausalHashId) -&gt; Transaction ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashHandle
-&gt; CausalBranch Transaction
-&gt; Transaction (BranchObjectId, CausalHashId)
</span><span class="hs-identifier hs-var">Ops.saveRootBranch</span></span><span> </span><span class="annot"><span class="annottext">HashHandle
</span><span class="hs-identifier hs-var">v2HashHandle</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Branch Transaction -&gt; CausalBranch Transaction
forall (m :: * -&gt; *). Monad m =&gt; Branch m -&gt; CausalBranch m
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#causalbranch1to2"><span class="hs-identifier hs-var">Cv.causalbranch1to2</span></a></span><span> </span><span class="annot"><span class="annottext">Branch Transaction
</span><a href="#local-6989586621680729391"><span class="hs-identifier hs-var">branch1</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-388"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; Transaction ()
forall a. IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; STM a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TVar (Maybe (DataVersion, Branch Transaction))
-&gt; (Maybe (DataVersion, Branch Transaction)
    -&gt; Maybe (DataVersion, Branch Transaction))
-&gt; STM ()
forall a. TVar a -&gt; (a -&gt; a) -&gt; STM ()
</span><span class="hs-identifier hs-var">modifyTVar'</span></span><span> </span><span class="annot"><span class="annottext">TVar (Maybe (DataVersion, Branch Transaction))
</span><a href="#local-6989586621680729392"><span class="hs-identifier hs-var">rootBranchCache</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((DataVersion, Branch Transaction)
 -&gt; (DataVersion, Branch Transaction))
-&gt; Maybe (DataVersion, Branch Transaction)
-&gt; Maybe (DataVersion, Branch Transaction)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(((DataVersion, Branch Transaction)
  -&gt; (DataVersion, Branch Transaction))
 -&gt; Maybe (DataVersion, Branch Transaction)
 -&gt; Maybe (DataVersion, Branch Transaction))
-&gt; ((Branch Transaction -&gt; Branch Transaction)
    -&gt; (DataVersion, Branch Transaction)
    -&gt; (DataVersion, Branch Transaction))
-&gt; (Branch Transaction -&gt; Branch Transaction)
-&gt; Maybe (DataVersion, Branch Transaction)
-&gt; Maybe (DataVersion, Branch Transaction)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Branch Transaction -&gt; Branch Transaction)
-&gt; (DataVersion, Branch Transaction)
-&gt; (DataVersion, Branch Transaction)
forall (p :: * -&gt; * -&gt; *) b c a.
Bifunctor p =&gt;
(b -&gt; c) -&gt; p a b -&gt; p a c
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="annot"><span class="annottext">((Branch Transaction -&gt; Branch Transaction)
 -&gt; Maybe (DataVersion, Branch Transaction)
 -&gt; Maybe (DataVersion, Branch Transaction))
-&gt; (Branch Transaction -&gt; Branch Transaction)
-&gt; Maybe (DataVersion, Branch Transaction)
-&gt; Maybe (DataVersion, Branch Transaction)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Branch Transaction -&gt; Branch Transaction -&gt; Branch Transaction
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Branch Transaction
</span><a href="#local-6989586621680729391"><span class="hs-identifier hs-var">branch1</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-389"></span><span>
</span><span id="line-390"></span><span class="hs-comment">-- if this blows up on cromulent hashes, then switch from `hashToHashId`</span><span>
</span><span id="line-391"></span><span class="hs-comment">-- to one that returns Maybe.</span><span>
</span><span id="line-392"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#getBranchForHash"><span class="hs-identifier hs-type">getBranchForHash</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-393"></span><span>  </span><span class="hs-comment">-- | A 'getDeclType'-like lookup, possibly backed by a cache.</span><span>
</span><span id="line-394"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-395"></span><span>  </span><span class="annot"><a href="Unison.Codebase.Causal.Type.html#CausalHash"><span class="hs-identifier hs-type">Branch.CausalHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-396"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.Branch.Type.html#Branch"><span class="hs-identifier hs-type">Branch</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-397"></span><span id="getBranchForHash"><span class="annot"><span class="annottext">getBranchForHash :: (Reference -&gt; Transaction ConstructorType)
-&gt; CausalHash -&gt; Transaction (Maybe (Branch Transaction))
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getBranchForHash"><span class="hs-identifier hs-var hs-var">getBranchForHash</span></a></span></span><span> </span><span id="local-6989586621680729386"><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680729386"><span class="hs-identifier hs-var">doGetDeclType</span></a></span></span><span> </span><span id="local-6989586621680729385"><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621680729385"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-398"></span><span>  </span><span class="annot"><span class="annottext">CausalHash -&gt; Transaction (Maybe (CausalBranch Transaction))
</span><span class="hs-identifier hs-var">Ops.loadCausalBranchByCausalHash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CausalHash -&gt; CausalHash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#causalHash1to2"><span class="hs-identifier hs-var">Cv.causalHash1to2</span></a></span><span> </span><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621680729385"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Transaction (Maybe (CausalBranch Transaction))
-&gt; (Maybe (CausalBranch Transaction)
    -&gt; Transaction (Maybe (Branch Transaction)))
-&gt; Transaction (Maybe (Branch Transaction))
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-399"></span><span>    </span><span class="annot"><span class="annottext">Maybe (CausalBranch Transaction)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Branch Transaction)
-&gt; Transaction (Maybe (Branch Transaction))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Branch Transaction)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-400"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680729382"><span class="annot"><span class="annottext">CausalBranch Transaction
</span><a href="#local-6989586621680729382"><span class="hs-identifier hs-var">causal2</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-401"></span><span>      </span><span id="local-6989586621680729381"><span class="annot"><span class="annottext">Branch Transaction
</span><a href="#local-6989586621680729381"><span class="hs-identifier hs-var">branch1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Reference -&gt; Transaction ConstructorType)
-&gt; CausalBranch Transaction -&gt; Transaction (Branch Transaction)
forall (m :: * -&gt; *).
Monad m =&gt;
(Reference -&gt; m ConstructorType) -&gt; CausalBranch m -&gt; m (Branch m)
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#causalbranch2to1"><span class="hs-identifier hs-var">Cv.causalbranch2to1</span></a></span><span> </span><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680729386"><span class="hs-identifier hs-var">doGetDeclType</span></a></span><span> </span><span class="annot"><span class="annottext">CausalBranch Transaction
</span><a href="#local-6989586621680729382"><span class="hs-identifier hs-var">causal2</span></a></span><span>
</span><span id="line-402"></span><span>      </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Branch Transaction -&gt; Maybe (Branch Transaction)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Branch Transaction
</span><a href="#local-6989586621680729381"><span class="hs-identifier hs-var">branch1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-403"></span><span>
</span><span id="line-404"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#putBranch"><span class="hs-identifier hs-type">putBranch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Codebase.Branch.Type.html#Branch"><span class="hs-identifier hs-type">Branch</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-405"></span><span id="putBranch"><span class="annot"><span class="annottext">putBranch :: Branch Transaction -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putBranch"><span class="hs-identifier hs-var hs-var">putBranch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-406"></span><span>  </span><span class="annot"><span class="annottext">Transaction (BranchObjectId, CausalHashId) -&gt; Transaction ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(Transaction (BranchObjectId, CausalHashId) -&gt; Transaction ())
-&gt; (Branch Transaction
    -&gt; Transaction (BranchObjectId, CausalHashId))
-&gt; Branch Transaction
-&gt; Transaction ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">HashHandle
-&gt; CausalBranch Transaction
-&gt; Transaction (BranchObjectId, CausalHashId)
</span><span class="hs-identifier hs-var">Ops.saveBranch</span></span><span> </span><span class="annot"><span class="annottext">HashHandle
</span><span class="hs-identifier hs-var">v2HashHandle</span></span><span> </span><span class="annot"><span class="annottext">(CausalBranch Transaction
 -&gt; Transaction (BranchObjectId, CausalHashId))
-&gt; (Branch Transaction -&gt; CausalBranch Transaction)
-&gt; Branch Transaction
-&gt; Transaction (BranchObjectId, CausalHashId)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Branch Transaction -&gt; CausalBranch Transaction
forall (m :: * -&gt; *). Monad m =&gt; Branch m -&gt; CausalBranch m
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#causalbranch1to2"><span class="hs-identifier hs-var">Cv.causalbranch1to2</span></a></span><span>
</span><span id="line-407"></span><span>
</span><span id="line-408"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#isCausalHash"><span class="hs-identifier hs-type">isCausalHash</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Codebase.Causal.Type.html#CausalHash"><span class="hs-identifier hs-type">Branch.CausalHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-409"></span><span id="isCausalHash"><span class="annot"><span class="annottext">isCausalHash :: CausalHash -&gt; Transaction Bool
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#isCausalHash"><span class="hs-identifier hs-var hs-var">isCausalHash</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.Causal.Type.html#CausalHash"><span class="hs-identifier hs-type">Causal.CausalHash</span></a></span><span> </span><span id="local-6989586621680729376"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729376"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-410"></span><span>  </span><span class="annot"><span class="annottext">Hash -&gt; Transaction (Maybe HashId)
</span><span class="hs-identifier hs-var">Q.loadHashIdByHash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Hash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#hash1to2"><span class="hs-identifier hs-var">Cv.hash1to2</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729376"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Transaction (Maybe HashId)
-&gt; (Maybe HashId -&gt; Transaction Bool) -&gt; Transaction Bool
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-411"></span><span>    </span><span class="annot"><span class="annottext">Maybe HashId
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Transaction Bool
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-412"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680729374"><span class="annot"><span class="annottext">HashId
</span><a href="#local-6989586621680729374"><span class="hs-identifier hs-var">hId</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HashId -&gt; Transaction Bool
</span><span class="hs-identifier hs-var">Q.isCausalHash</span></span><span> </span><span class="annot"><span class="annottext">HashId
</span><a href="#local-6989586621680729374"><span class="hs-identifier hs-var">hId</span></a></span><span>
</span><span id="line-413"></span><span>
</span><span id="line-414"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#getPatch"><span class="hs-identifier hs-type">getPatch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Codebase.Branch.Type.html#EditHash"><span class="hs-identifier hs-type">Branch.EditHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Unison.Codebase.Patch.html#Patch"><span class="hs-identifier hs-type">Patch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-415"></span><span id="getPatch"><span class="annot"><span class="annottext">getPatch :: Hash -&gt; Transaction (Maybe Patch)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getPatch"><span class="hs-identifier hs-var hs-var">getPatch</span></a></span></span><span> </span><span id="local-6989586621680729370"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729370"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-416"></span><span>  </span><span class="annot"><span class="annottext">MaybeT Transaction Patch -&gt; Transaction (Maybe Patch)
forall (m :: * -&gt; *) a. MaybeT m a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var hs-var">runMaybeT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-417"></span><span>    </span><span id="local-6989586621680729369"><span class="annot"><span class="annottext">PatchObjectId
</span><a href="#local-6989586621680729369"><span class="hs-identifier hs-var">patchId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Transaction (Maybe PatchObjectId)
-&gt; MaybeT Transaction PatchObjectId
forall (m :: * -&gt; *) a. m (Maybe a) -&gt; MaybeT m a
</span><span class="hs-identifier hs-var">MaybeT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatchHash -&gt; Transaction (Maybe PatchObjectId)
</span><span class="hs-identifier hs-var">Q.loadPatchObjectIdForPrimaryHash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; PatchHash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#patchHash1to2"><span class="hs-identifier hs-var">Cv.patchHash1to2</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729370"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-418"></span><span>    </span><span id="local-6989586621680729365"><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621680729365"><span class="hs-identifier hs-var">patch</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Transaction Patch -&gt; MaybeT Transaction Patch
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatchObjectId -&gt; Transaction Patch
</span><span class="hs-identifier hs-var">Ops.expectPatch</span></span><span> </span><span class="annot"><span class="annottext">PatchObjectId
</span><a href="#local-6989586621680729369"><span class="hs-identifier hs-var">patchId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-419"></span><span>    </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Patch -&gt; Patch
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#patch2to1"><span class="hs-identifier hs-var">Cv.patch2to1</span></a></span><span> </span><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621680729365"><span class="hs-identifier hs-var">patch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-420"></span><span>
</span><span id="line-421"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#putPatch"><span class="hs-identifier hs-type">putPatch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Codebase.Branch.Type.html#EditHash"><span class="hs-identifier hs-type">Branch.EditHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Codebase.Patch.html#Patch"><span class="hs-identifier hs-type">Patch</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-422"></span><span id="putPatch"><span class="annot"><span class="annottext">putPatch :: Hash -&gt; Patch -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putPatch"><span class="hs-identifier hs-var hs-var">putPatch</span></a></span></span><span> </span><span id="local-6989586621680729361"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729361"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621680729360"><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621680729360"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-423"></span><span>  </span><span class="annot"><span class="annottext">Transaction PatchObjectId -&gt; Transaction ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(Transaction PatchObjectId -&gt; Transaction ())
-&gt; Transaction PatchObjectId -&gt; Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashHandle -&gt; PatchHash -&gt; Patch -&gt; Transaction PatchObjectId
</span><span class="hs-identifier hs-var">Ops.savePatch</span></span><span> </span><span class="annot"><span class="annottext">HashHandle
</span><span class="hs-identifier hs-var">v2HashHandle</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; PatchHash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#patchHash1to2"><span class="hs-identifier hs-var">Cv.patchHash1to2</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729361"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Patch -&gt; Patch
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#patch1to2"><span class="hs-identifier hs-var">Cv.patch1to2</span></a></span><span> </span><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621680729360"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-424"></span><span>
</span><span id="line-425"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#patchExists"><span class="hs-identifier hs-type">patchExists</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Codebase.Branch.Type.html#EditHash"><span class="hs-identifier hs-type">Branch.EditHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-426"></span><span id="patchExists"><span class="annot"><span class="annottext">patchExists :: Hash -&gt; Transaction Bool
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#patchExists"><span class="hs-identifier hs-var hs-var">patchExists</span></a></span></span><span> </span><span id="local-6989586621680729356"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729356"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Maybe PatchObjectId -&gt; Bool)
-&gt; Transaction (Maybe PatchObjectId) -&gt; Transaction Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Maybe PatchObjectId -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Transaction (Maybe PatchObjectId) -&gt; Transaction Bool)
-&gt; Transaction (Maybe PatchObjectId) -&gt; Transaction Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatchHash -&gt; Transaction (Maybe PatchObjectId)
</span><span class="hs-identifier hs-var">Q.loadPatchObjectIdForPrimaryHash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; PatchHash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#patchHash1to2"><span class="hs-identifier hs-var">Cv.patchHash1to2</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729356"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-427"></span><span>
</span><span id="line-428"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#dependentsImpl"><span class="hs-identifier hs-type">dependentsImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span class="hs-special">)</span><span>
</span><span id="line-429"></span><span id="dependentsImpl"><span class="annot"><span class="annottext">dependentsImpl :: Reference -&gt; Transaction (Set Id)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#dependentsImpl"><span class="hs-identifier hs-var hs-var">dependentsImpl</span></a></span></span><span> </span><span id="local-6989586621680729354"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621680729354"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-430"></span><span>  </span><span class="annot"><span class="annottext">(Id -&gt; Id) -&gt; Set Id -&gt; Set Id
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">Set.map</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#referenceid2to1"><span class="hs-identifier hs-var">Cv.referenceid2to1</span></a></span><span>
</span><span id="line-431"></span><span>    </span><span class="annot"><span class="annottext">(Set Id -&gt; Set Id) -&gt; Transaction (Set Id) -&gt; Transaction (Set Id)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Reference -&gt; Transaction (Set Id)
</span><span class="hs-identifier hs-var">Ops.dependents</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reference -&gt; Reference
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#reference1to2"><span class="hs-identifier hs-var">Cv.reference1to2</span></a></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621680729354"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-432"></span><span>
</span><span id="line-433"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#dependentsOfComponentImpl"><span class="hs-identifier hs-type">dependentsOfComponentImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span class="hs-special">)</span><span>
</span><span id="line-434"></span><span id="dependentsOfComponentImpl"><span class="annot"><span class="annottext">dependentsOfComponentImpl :: Hash -&gt; Transaction (Set Id)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#dependentsOfComponentImpl"><span class="hs-identifier hs-var hs-var">dependentsOfComponentImpl</span></a></span></span><span> </span><span id="local-6989586621680729350"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729350"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-435"></span><span>  </span><span class="annot"><span class="annottext">(Id -&gt; Id) -&gt; Set Id -&gt; Set Id
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">Set.map</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#referenceid2to1"><span class="hs-identifier hs-var">Cv.referenceid2to1</span></a></span><span>
</span><span id="line-436"></span><span>    </span><span class="annot"><span class="annottext">(Set Id -&gt; Set Id) -&gt; Transaction (Set Id) -&gt; Transaction (Set Id)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Transaction (Set Id)
</span><span class="hs-identifier hs-var">Ops.dependentsOfComponent</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Hash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#hash1to2"><span class="hs-identifier hs-var">Cv.hash1to2</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729350"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-437"></span><span>
</span><span id="line-438"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#watches"><span class="hs-identifier hs-type">watches</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">UF.WatchKind</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span class="hs-special">]</span><span>
</span><span id="line-439"></span><span id="watches"><span class="annot"><span class="annottext">watches :: String -&gt; Transaction [Id]
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#watches"><span class="hs-identifier hs-var hs-var">watches</span></a></span></span><span> </span><span id="local-6989586621680729346"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680729346"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-440"></span><span>  </span><span class="annot"><span class="annottext">WatchKind -&gt; Transaction [Id]
</span><span class="hs-identifier hs-var">Ops.listWatches</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; WatchKind
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#watchKind1to2"><span class="hs-identifier hs-var">Cv.watchKind1to2</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680729346"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-441"></span><span>    </span><span class="annot"><span class="annottext">Transaction [Id] -&gt; ([Id] -&gt; [Id]) -&gt; Transaction [Id]
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Id) -&gt; [Id] -&gt; [Id]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#referenceid2to1"><span class="hs-identifier hs-var">Cv.referenceid2to1</span></a></span><span>
</span><span id="line-442"></span><span>
</span><span id="line-443"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#getWatch"><span class="hs-identifier hs-type">getWatch</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-444"></span><span>  </span><span class="hs-comment">-- | A 'getDeclType'-like lookup, possibly backed by a cache.</span><span>
</span><span id="line-445"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-446"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">UF.WatchKind</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-447"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-448"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><a href="Unison.Parser.Ann.html#Ann"><span class="hs-identifier hs-type">Ann</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-449"></span><span id="getWatch"><span class="annot"><span class="annottext">getWatch :: (Reference -&gt; Transaction ConstructorType)
-&gt; String -&gt; Id -&gt; Transaction (Maybe (Term Symbol Ann))
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getWatch"><span class="hs-identifier hs-var hs-var">getWatch</span></a></span></span><span> </span><span id="local-6989586621680729342"><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680729342"><span class="hs-identifier hs-var">doGetDeclType</span></a></span></span><span> </span><span id="local-6989586621680729341"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680729341"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621680729340"><span class="annot"><span class="annottext">r :: Id
</span><a href="#local-6989586621680729340"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span id="local-6989586621680729339"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729339"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621680729338"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729338"><span class="hs-identifier hs-var">_i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-450"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">String -&gt; [String] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">elem</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680729341"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#standardWatchKinds"><span class="hs-identifier hs-var">standardWatchKinds</span></a></span><span>
</span><span id="line-451"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">MaybeT Transaction (Term Symbol Ann)
-&gt; Transaction (Maybe (Term Symbol Ann))
forall (m :: * -&gt; *) a. MaybeT m a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var hs-var">runMaybeT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-452"></span><span>      </span><span id="local-6989586621680729335"><span class="annot"><span class="annottext">Term Symbol
</span><a href="#local-6989586621680729335"><span class="hs-identifier hs-var">watch</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WatchKind -&gt; Id -&gt; MaybeT Transaction (Term Symbol)
</span><span class="hs-identifier hs-var">Ops.loadWatch</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; WatchKind
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#watchKind1to2"><span class="hs-identifier hs-var">Cv.watchKind1to2</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680729341"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#referenceid1to2"><span class="hs-identifier hs-var">Cv.referenceid1to2</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621680729340"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-453"></span><span>      </span><span class="annot"><span class="annottext">Transaction (Term Symbol Ann)
-&gt; MaybeT Transaction (Term Symbol Ann)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash
-&gt; (Reference -&gt; Transaction ConstructorType)
-&gt; Term Symbol
-&gt; Transaction (Term Symbol Ann)
forall (m :: * -&gt; *).
Monad m =&gt;
Hash
-&gt; (Reference -&gt; m ConstructorType)
-&gt; Term Symbol
-&gt; m (Term Symbol Ann)
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#term2to1"><span class="hs-identifier hs-var">Cv.term2to1</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729339"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680729342"><span class="hs-identifier hs-var">doGetDeclType</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol
</span><a href="#local-6989586621680729335"><span class="hs-identifier hs-var">watch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-454"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe (Term Symbol Ann) -&gt; Transaction (Maybe (Term Symbol Ann))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Term Symbol Ann)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-455"></span><span>
</span><span id="line-456"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#putWatch"><span class="hs-identifier hs-type">putWatch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">UF.WatchKind</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><a href="Unison.Parser.Ann.html#Ann"><span class="hs-identifier hs-type">Ann</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-457"></span><span id="putWatch"><span class="annot"><span class="annottext">putWatch :: String -&gt; Id -&gt; Term Symbol Ann -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putWatch"><span class="hs-identifier hs-var hs-var">putWatch</span></a></span></span><span> </span><span id="local-6989586621680729331"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680729331"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621680729330"><span class="annot"><span class="annottext">r :: Id
</span><a href="#local-6989586621680729330"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span id="local-6989586621680729329"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729329"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621680729328"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729328"><span class="hs-identifier hs-var">_i</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680729327"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680729327"><span class="hs-identifier hs-var">tm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-458"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Transaction () -&gt; Transaction ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; [String] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">elem</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680729331"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#standardWatchKinds"><span class="hs-identifier hs-var">standardWatchKinds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-459"></span><span>    </span><span class="annot"><span class="annottext">WatchKind -&gt; Id -&gt; Term Symbol -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Ops.saveWatch</span></span><span>
</span><span id="line-460"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; WatchKind
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#watchKind1to2"><span class="hs-identifier hs-var">Cv.watchKind1to2</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680729331"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-461"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#referenceid1to2"><span class="hs-identifier hs-var">Cv.referenceid1to2</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621680729330"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-462"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Term Symbol Ann -&gt; Term Symbol
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#term1to2"><span class="hs-identifier hs-var">Cv.term1to2</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729329"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680729327"><span class="hs-identifier hs-var">tm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-463"></span><span>
</span><span id="line-464"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#standardWatchKinds"><span class="hs-identifier hs-type">standardWatchKinds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">UF.WatchKind</span></span><span class="hs-special">]</span><span>
</span><span id="line-465"></span><span id="standardWatchKinds"><span class="annot"><span class="annottext">standardWatchKinds :: [String]
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#standardWatchKinds"><span class="hs-identifier hs-var hs-var">standardWatchKinds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
forall a. (Eq a, IsString a) =&gt; a
</span><span class="hs-identifier hs-var">UF.RegularWatch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
forall a. (Eq a, IsString a) =&gt; a
</span><span class="hs-identifier hs-var">UF.TestWatch</span></span><span class="hs-special">]</span><span>
</span><span id="line-466"></span><span>
</span><span id="line-467"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#clearWatches"><span class="hs-identifier hs-type">clearWatches</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-468"></span><span id="clearWatches"><span class="annot"><span class="annottext">clearWatches :: Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#clearWatches"><span class="hs-identifier hs-var hs-var">clearWatches</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Transaction ()
</span><span class="hs-identifier hs-var">Ops.clearWatches</span></span><span>
</span><span id="line-469"></span><span>
</span><span id="line-470"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#termsOfTypeImpl"><span class="hs-identifier hs-type">termsOfTypeImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-471"></span><span>  </span><span class="hs-comment">-- | A 'getDeclType'-like lookup, possibly backed by a cache.</span><span>
</span><span id="line-472"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-473"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-474"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent.Id</span></span><span class="hs-special">)</span><span>
</span><span id="line-475"></span><span id="termsOfTypeImpl"><span class="annot"><span class="annottext">termsOfTypeImpl :: (Reference -&gt; Transaction ConstructorType)
-&gt; Reference -&gt; Transaction (Set Id)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#termsOfTypeImpl"><span class="hs-identifier hs-var hs-var">termsOfTypeImpl</span></a></span></span><span> </span><span id="local-6989586621680729319"><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680729319"><span class="hs-identifier hs-var">doGetDeclType</span></a></span></span><span> </span><span id="local-6989586621680729318"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621680729318"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-476"></span><span>  </span><span class="annot"><span class="annottext">Reference -&gt; Transaction (Set Id)
</span><span class="hs-identifier hs-var">Ops.termsHavingType</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reference -&gt; Reference
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#reference1to2"><span class="hs-identifier hs-var">Cv.reference1to2</span></a></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621680729318"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-477"></span><span>    </span><span class="annot"><span class="annottext">Transaction (Set Id)
-&gt; (Set Id -&gt; Transaction (Set Id)) -&gt; Transaction (Set Id)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Transaction Id) -&gt; Set Id -&gt; Transaction (Set Id)
forall (f :: * -&gt; *) b a.
(Applicative f, Ord b) =&gt;
(a -&gt; f b) -&gt; Set a -&gt; f (Set b)
</span><span class="hs-identifier hs-var">Set.traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Reference -&gt; Transaction ConstructorType) -&gt; Id -&gt; Transaction Id
forall (m :: * -&gt; *).
Applicative m =&gt;
(Reference -&gt; m ConstructorType) -&gt; Id -&gt; m Id
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#referentid2to1"><span class="hs-identifier hs-var">Cv.referentid2to1</span></a></span><span> </span><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680729319"><span class="hs-identifier hs-var">doGetDeclType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-478"></span><span>
</span><span id="line-479"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#termsMentioningTypeImpl"><span class="hs-identifier hs-type">termsMentioningTypeImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-480"></span><span>  </span><span class="hs-comment">-- | A 'getDeclType'-like lookup, possibly backed by a cache.</span><span>
</span><span id="line-481"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-482"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-483"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent.Id</span></span><span class="hs-special">)</span><span>
</span><span id="line-484"></span><span id="termsMentioningTypeImpl"><span class="annot"><span class="annottext">termsMentioningTypeImpl :: (Reference -&gt; Transaction ConstructorType)
-&gt; Reference -&gt; Transaction (Set Id)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#termsMentioningTypeImpl"><span class="hs-identifier hs-var hs-var">termsMentioningTypeImpl</span></a></span></span><span> </span><span id="local-6989586621680729313"><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680729313"><span class="hs-identifier hs-var">doGetDeclType</span></a></span></span><span> </span><span id="local-6989586621680729312"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621680729312"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-485"></span><span>  </span><span class="annot"><span class="annottext">Reference -&gt; Transaction (Set Id)
</span><span class="hs-identifier hs-var">Ops.termsMentioningType</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reference -&gt; Reference
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#reference1to2"><span class="hs-identifier hs-var">Cv.reference1to2</span></a></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621680729312"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-486"></span><span>    </span><span class="annot"><span class="annottext">Transaction (Set Id)
-&gt; (Set Id -&gt; Transaction (Set Id)) -&gt; Transaction (Set Id)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Transaction Id) -&gt; Set Id -&gt; Transaction (Set Id)
forall (f :: * -&gt; *) b a.
(Applicative f, Ord b) =&gt;
(a -&gt; f b) -&gt; Set a -&gt; f (Set b)
</span><span class="hs-identifier hs-var">Set.traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Reference -&gt; Transaction ConstructorType) -&gt; Id -&gt; Transaction Id
forall (m :: * -&gt; *).
Applicative m =&gt;
(Reference -&gt; m ConstructorType) -&gt; Id -&gt; m Id
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#referentid2to1"><span class="hs-identifier hs-var">Cv.referentid2to1</span></a></span><span> </span><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680729313"><span class="hs-identifier hs-var">doGetDeclType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-487"></span><span>
</span><span id="line-488"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#hashLength"><span class="hs-identifier hs-type">hashLength</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-489"></span><span id="hashLength"><span class="annot"><span class="annottext">hashLength :: Transaction Int
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#hashLength"><span class="hs-identifier hs-var hs-var">hashLength</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Transaction Int
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">10</span></span><span>
</span><span id="line-490"></span><span>
</span><span id="line-491"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#branchHashLength"><span class="hs-identifier hs-type">branchHashLength</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-492"></span><span id="branchHashLength"><span class="annot"><span class="annottext">branchHashLength :: Transaction Int
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#branchHashLength"><span class="hs-identifier hs-var hs-var">branchHashLength</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Transaction Int
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">10</span></span><span>
</span><span id="line-493"></span><span>
</span><span id="line-494"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#defnReferencesByPrefix"><span class="hs-identifier hs-type">defnReferencesByPrefix</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OT.ObjectType</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ShortHash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span class="hs-special">)</span><span>
</span><span id="line-495"></span><span id="defnReferencesByPrefix"><span class="annot"><span class="annottext">defnReferencesByPrefix :: ObjectType -&gt; ShortHash -&gt; Transaction (Set Id)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#defnReferencesByPrefix"><span class="hs-identifier hs-var hs-var">defnReferencesByPrefix</span></a></span></span><span> </span><span class="annot"><span class="annottext">ObjectType
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ShortHash.Builtin</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set Id -&gt; Transaction (Set Id)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Set Id
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-496"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#defnReferencesByPrefix"><span class="hs-identifier hs-var">defnReferencesByPrefix</span></a></span><span> </span><span id="local-6989586621680729306"><span class="annot"><span class="annottext">ObjectType
</span><a href="#local-6989586621680729306"><span class="hs-identifier hs-var">ot</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ShortHash.ShortHash</span></span><span> </span><span id="local-6989586621680729304"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680729304"><span class="hs-identifier hs-var">prefix</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Text -&gt; Word64) -&gt; Maybe Text -&gt; Maybe Word64
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Word64
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#shortHashSuffix1to2"><span class="hs-identifier hs-var">Cv.shortHashSuffix1to2</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621680729302"><span class="annot"><span class="annottext">Maybe Word64
</span><a href="#local-6989586621680729302"><span class="hs-identifier hs-var">cycle</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680729301"><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621680729301"><span class="hs-identifier hs-var">_cid</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-497"></span><span>  </span><span id="local-6989586621680729300"><span class="annot"><span class="annottext">Set Id
</span><a href="#local-6989586621680729300"><span class="hs-identifier hs-var">refs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-498"></span><span>    </span><span class="annot"><span class="annottext">ObjectType -&gt; Text -&gt; Maybe Word64 -&gt; Transaction [Id' ObjectId]
</span><span class="hs-identifier hs-var">Ops.componentReferencesByPrefix</span></span><span> </span><span class="annot"><span class="annottext">ObjectType
</span><a href="#local-6989586621680729306"><span class="hs-identifier hs-var">ot</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680729304"><span class="hs-identifier hs-var">prefix</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Word64
</span><a href="#local-6989586621680729302"><span class="hs-identifier hs-var">cycle</span></a></span><span>
</span><span id="line-499"></span><span>      </span><span class="annot"><span class="annottext">Transaction [Id' ObjectId]
-&gt; ([Id' ObjectId] -&gt; Transaction [Id]) -&gt; Transaction [Id]
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(Id' ObjectId -&gt; Transaction Id)
-&gt; [Id' ObjectId] -&gt; Transaction [Id]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ObjectId -&gt; Transaction Hash) -&gt; Id' ObjectId -&gt; Transaction Id
forall h h'. Lens (Id' h) (Id' h') h h'
</span><span class="hs-identifier hs-var">C.Reference.idH</span></span><span> </span><span class="annot"><span class="annottext">ObjectId -&gt; Transaction Hash
</span><span class="hs-identifier hs-var">Q.expectPrimaryHashByObjectId</span></span><span class="hs-special">)</span><span>
</span><span id="line-500"></span><span>      </span><span class="annot"><span class="annottext">Transaction [Id]
-&gt; ([Id] -&gt; Transaction (Set Id)) -&gt; Transaction (Set Id)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Set Id -&gt; Transaction (Set Id)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Set Id -&gt; Transaction (Set Id))
-&gt; ([Id] -&gt; Set Id) -&gt; [Id] -&gt; Transaction (Set Id)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; Set Id
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span>
</span><span id="line-501"></span><span>  </span><span class="hs-identifier">pure</span><span> </span><span class="hs-operator">$</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Id) -&gt; Set Id -&gt; Set Id
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">Set.map</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#referenceid2to1"><span class="hs-identifier hs-var">Cv.referenceid2to1</span></a></span><span> </span><span class="annot"><span class="annottext">Set Id
</span><a href="#local-6989586621680729300"><span class="hs-identifier hs-var">refs</span></a></span><span>
</span><span id="line-502"></span><span>
</span><span id="line-503"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#termReferencesByPrefix"><span class="hs-identifier hs-type">termReferencesByPrefix</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ShortHash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span class="hs-special">)</span><span>
</span><span id="line-504"></span><span id="termReferencesByPrefix"><span class="annot"><span class="annottext">termReferencesByPrefix :: ShortHash -&gt; Transaction (Set Id)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#termReferencesByPrefix"><span class="hs-identifier hs-var hs-var">termReferencesByPrefix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ObjectType -&gt; ShortHash -&gt; Transaction (Set Id)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#defnReferencesByPrefix"><span class="hs-identifier hs-var">defnReferencesByPrefix</span></a></span><span> </span><span class="annot"><span class="annottext">ObjectType
</span><span class="hs-identifier hs-var">OT.TermComponent</span></span><span>
</span><span id="line-505"></span><span>
</span><span id="line-506"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#declReferencesByPrefix"><span class="hs-identifier hs-type">declReferencesByPrefix</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ShortHash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span class="hs-special">)</span><span>
</span><span id="line-507"></span><span id="declReferencesByPrefix"><span class="annot"><span class="annottext">declReferencesByPrefix :: ShortHash -&gt; Transaction (Set Id)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#declReferencesByPrefix"><span class="hs-identifier hs-var hs-var">declReferencesByPrefix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ObjectType -&gt; ShortHash -&gt; Transaction (Set Id)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#defnReferencesByPrefix"><span class="hs-identifier hs-var">defnReferencesByPrefix</span></a></span><span> </span><span class="annot"><span class="annottext">ObjectType
</span><span class="hs-identifier hs-var">OT.DeclComponent</span></span><span>
</span><span id="line-508"></span><span>
</span><span id="line-509"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#referentsByPrefix"><span class="hs-identifier hs-type">referentsByPrefix</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-510"></span><span>  </span><span class="hs-comment">-- | A 'getDeclType'-like lookup, possibly backed by a cache.</span><span>
</span><span id="line-511"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-512"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">ShortHash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-513"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent.Id</span></span><span class="hs-special">)</span><span>
</span><span id="line-514"></span><span id="referentsByPrefix"><span class="annot"><span class="annottext">referentsByPrefix :: (Reference -&gt; Transaction ConstructorType)
-&gt; ShortHash -&gt; Transaction (Set Id)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#referentsByPrefix"><span class="hs-identifier hs-var hs-var">referentsByPrefix</span></a></span></span><span> </span><span id="local-6989586621680729290"><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680729290"><span class="hs-identifier hs-var">_doGetDeclType</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SH.Builtin</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set Id -&gt; Transaction (Set Id)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Set Id
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-515"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#referentsByPrefix"><span class="hs-identifier hs-var">referentsByPrefix</span></a></span><span> </span><span id="local-6989586621680729289"><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680729289"><span class="hs-identifier hs-var">doGetDeclType</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SH.ShortHash</span></span><span> </span><span id="local-6989586621680729288"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680729288"><span class="hs-identifier hs-var">prefix</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Text -&gt; Word64) -&gt; Maybe Text -&gt; Maybe Word64
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Word64
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#shortHashSuffix1to2"><span class="hs-identifier hs-var">Cv.shortHashSuffix1to2</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621680729287"><span class="annot"><span class="annottext">Maybe Word64
</span><a href="#local-6989586621680729287"><span class="hs-identifier hs-var">cycle</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680729286"><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621680729286"><span class="hs-identifier hs-var">cid</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-516"></span><span>  </span><span id="local-6989586621680729285"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621680729285"><span class="hs-identifier hs-var">termReferents</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-517"></span><span>    </span><span class="annot"><span class="annottext">Text -&gt; Maybe Word64 -&gt; Transaction [Id]
</span><span class="hs-identifier hs-var">Ops.termReferentsByPrefix</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680729288"><span class="hs-identifier hs-var">prefix</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Word64
</span><a href="#local-6989586621680729287"><span class="hs-identifier hs-var">cycle</span></a></span><span>
</span><span id="line-518"></span><span>      </span><span class="annot"><span class="annottext">Transaction [Id] -&gt; ([Id] -&gt; Transaction [Id]) -&gt; Transaction [Id]
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Transaction Id) -&gt; [Id] -&gt; Transaction [Id]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Reference -&gt; Transaction ConstructorType) -&gt; Id -&gt; Transaction Id
forall (m :: * -&gt; *).
Applicative m =&gt;
(Reference -&gt; m ConstructorType) -&gt; Id -&gt; m Id
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#referentid2to1"><span class="hs-identifier hs-var">Cv.referentid2to1</span></a></span><span> </span><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680729289"><span class="hs-identifier hs-var">doGetDeclType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-519"></span><span>  </span><span id="local-6989586621680729283"><span class="annot"><span class="annottext">[(Hash, Word64, DeclType, [Word64])]
</span><a href="#local-6989586621680729283"><span class="hs-identifier hs-var">declReferents'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Text
-&gt; Maybe Word64
-&gt; Maybe Word64
-&gt; Transaction [(Hash, Word64, DeclType, [Word64])]
</span><span class="hs-identifier hs-var">Ops.declReferentsByPrefix</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680729288"><span class="hs-identifier hs-var">prefix</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Word64
</span><a href="#local-6989586621680729287"><span class="hs-identifier hs-var">cycle</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Word64
forall a. Read a =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">read</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Word64) -&gt; (Text -&gt; String) -&gt; Text -&gt; Word64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">Text.unpack</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Word64) -&gt; Maybe Text -&gt; Maybe Word64
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621680729286"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-520"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680729279"><span class="annot"><span class="annottext">declReferents :: [Id]
</span><a href="#local-6989586621680729279"><span class="hs-identifier hs-var hs-var">declReferents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-521"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">ConstructorReferenceId -&gt; ConstructorType -&gt; Id
</span><span class="hs-identifier hs-var">Referent.ConId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Word64 -&gt; ConstructorReferenceId
forall r. r -&gt; Word64 -&gt; GConstructorReference r
</span><span class="hs-identifier hs-var">ConstructorReference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Word64 -&gt; Id
</span><span class="hs-identifier hs-var">Reference.Id</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Hash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#hash2to1"><span class="hs-identifier hs-var">Cv.hash2to1</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729275"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729274"><span class="hs-identifier hs-var">pos</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729273"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DeclType -&gt; ConstructorType
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#decltype2to1"><span class="hs-identifier hs-var">Cv.decltype2to1</span></a></span><span> </span><span class="annot"><span class="annottext">DeclType
</span><a href="#local-6989586621680729272"><span class="hs-identifier hs-var">ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-522"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680729275"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680729275"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680729274"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729274"><span class="hs-identifier hs-var">pos</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680729272"><span class="annot"><span class="annottext">DeclType
</span><a href="#local-6989586621680729272"><span class="hs-identifier hs-var">ct</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680729271"><span class="annot"><span class="annottext">[Word64]
</span><a href="#local-6989586621680729271"><span class="hs-identifier hs-var">cids</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Hash, Word64, DeclType, [Word64])]
</span><a href="#local-6989586621680729283"><span class="hs-identifier hs-var">declReferents'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-523"></span><span>            </span><span id="local-6989586621680729273"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729273"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Word64]
</span><a href="#local-6989586621680729271"><span class="hs-identifier hs-var">cids</span></a></span><span>
</span><span id="line-524"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-525"></span><span>  </span><span class="annot"><span class="annottext">Set Id -&gt; Transaction (Set Id)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Set Id -&gt; Transaction (Set Id))
-&gt; ([Id] -&gt; Set Id) -&gt; [Id] -&gt; Transaction (Set Id)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; Set Id
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="annot"><span class="annottext">([Id] -&gt; Transaction (Set Id)) -&gt; [Id] -&gt; Transaction (Set Id)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621680729285"><span class="hs-identifier hs-var">termReferents</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Id] -&gt; [Id]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621680729279"><span class="hs-identifier hs-var">declReferents</span></a></span><span>
</span><span id="line-526"></span><span>
</span><span id="line-527"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#branchHashesByPrefix"><span class="hs-identifier hs-type">branchHashesByPrefix</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Codebase.ShortBranchHash.html#ShortBranchHash"><span class="hs-identifier hs-type">ShortBranchHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><a href="Unison.Codebase.Causal.Type.html#CausalHash"><span class="hs-identifier hs-type">Branch.CausalHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-528"></span><span id="branchHashesByPrefix"><span class="annot"><span class="annottext">branchHashesByPrefix :: ShortBranchHash -&gt; Transaction (Set CausalHash)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#branchHashesByPrefix"><span class="hs-identifier hs-var hs-var">branchHashesByPrefix</span></a></span></span><span> </span><span id="local-6989586621680729269"><span class="annot"><span class="annottext">ShortBranchHash
</span><a href="#local-6989586621680729269"><span class="hs-identifier hs-var">sh</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-529"></span><span>  </span><span class="hs-comment">-- given that a Branch is shallow, it's really `CausalHash` that you'd</span><span>
</span><span id="line-530"></span><span>  </span><span class="hs-comment">-- refer to to specify a full namespace w/ history.</span><span>
</span><span id="line-531"></span><span>  </span><span class="hs-comment">-- but do we want to be able to refer to a namespace without its history?</span><span>
</span><span id="line-532"></span><span>  </span><span id="local-6989586621680729268"><span class="annot"><span class="annottext">Set CausalHash
</span><a href="#local-6989586621680729268"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ShortBranchHash -&gt; Transaction (Set CausalHash)
</span><span class="hs-identifier hs-var">Ops.causalHashesByPrefix</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ShortBranchHash -&gt; ShortBranchHash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#sbh1to2"><span class="hs-identifier hs-var">Cv.sbh1to2</span></a></span><span> </span><span class="annot"><span class="annottext">ShortBranchHash
</span><a href="#local-6989586621680729269"><span class="hs-identifier hs-var">sh</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-533"></span><span>  </span><span class="hs-identifier">pure</span><span> </span><span class="hs-operator">$</span><span> </span><span class="annot"><span class="annottext">(CausalHash -&gt; CausalHash) -&gt; Set CausalHash -&gt; Set CausalHash
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">Set.map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; CausalHash
</span><a href="Unison.Codebase.Causal.Type.html#CausalHash"><span class="hs-identifier hs-var">Causal.CausalHash</span></a></span><span> </span><span class="annot"><span class="annottext">(Hash -&gt; CausalHash)
-&gt; (CausalHash -&gt; Hash) -&gt; CausalHash -&gt; CausalHash
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Hash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#hash2to1"><span class="hs-identifier hs-var">Cv.hash2to1</span></a></span><span> </span><span class="annot"><span class="annottext">(Hash -&gt; Hash) -&gt; (CausalHash -&gt; Hash) -&gt; CausalHash -&gt; Hash
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">CausalHash -&gt; Hash
</span><span class="hs-identifier hs-var hs-var">unCausalHash</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Set CausalHash
</span><a href="#local-6989586621680729268"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-534"></span><span>
</span><span id="line-535"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#sqlLca"><span class="hs-identifier hs-type">sqlLca</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Codebase.Causal.Type.html#CausalHash"><span class="hs-identifier hs-type">Branch.CausalHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Codebase.Causal.Type.html#CausalHash"><span class="hs-identifier hs-type">Branch.CausalHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Unison.Codebase.Causal.Type.html#CausalHash"><span class="hs-identifier hs-type">Branch.CausalHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-536"></span><span id="sqlLca"><span class="annot"><span class="annottext">sqlLca :: CausalHash -&gt; CausalHash -&gt; Transaction (Maybe CausalHash)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#sqlLca"><span class="hs-identifier hs-var hs-var">sqlLca</span></a></span></span><span> </span><span id="local-6989586621680729264"><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621680729264"><span class="hs-identifier hs-var">h1</span></a></span></span><span> </span><span id="local-6989586621680729263"><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621680729263"><span class="hs-identifier hs-var">h2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-537"></span><span>  </span><span id="local-6989586621680729262"><span class="annot"><span class="annottext">Maybe CausalHash
</span><a href="#local-6989586621680729262"><span class="hs-identifier hs-var">h3</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CausalHash -&gt; CausalHash -&gt; Transaction (Maybe CausalHash)
</span><span class="hs-identifier hs-var">Ops.lca</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CausalHash -&gt; CausalHash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#causalHash1to2"><span class="hs-identifier hs-var">Cv.causalHash1to2</span></a></span><span> </span><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621680729264"><span class="hs-identifier hs-var">h1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CausalHash -&gt; CausalHash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#causalHash1to2"><span class="hs-identifier hs-var">Cv.causalHash1to2</span></a></span><span> </span><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621680729263"><span class="hs-identifier hs-var">h2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-538"></span><span>  </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CausalHash -&gt; CausalHash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#causalHash2to1"><span class="hs-identifier hs-var">Cv.causalHash2to1</span></a></span><span> </span><span class="annot"><span class="annottext">(CausalHash -&gt; CausalHash) -&gt; Maybe CausalHash -&gt; Maybe CausalHash
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe CausalHash
</span><a href="#local-6989586621680729262"><span class="hs-identifier hs-var">h3</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-539"></span><span>
</span><span id="line-540"></span><span class="hs-comment">-- well one or the other. :zany_face: the thinking being that they wouldn't hash-collide</span><span>
</span><span id="line-541"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#termExists"><span class="hs-identifier hs-type">termExists</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#declExists"><span class="hs-identifier hs-type">declExists</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-542"></span><span id="termExists"><span class="annot"><span class="annottext">termExists :: Hash -&gt; Transaction Bool
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#termExists"><span class="hs-identifier hs-var hs-var">termExists</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Maybe ObjectId -&gt; Bool)
-&gt; Transaction (Maybe ObjectId) -&gt; Transaction Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Maybe ObjectId -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Transaction (Maybe ObjectId) -&gt; Transaction Bool)
-&gt; (Hash -&gt; Transaction (Maybe ObjectId))
-&gt; Hash
-&gt; Transaction Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Transaction (Maybe ObjectId)
</span><span class="hs-identifier hs-var">Q.loadObjectIdForPrimaryHash</span></span><span> </span><span class="annot"><span class="annottext">(Hash -&gt; Transaction (Maybe ObjectId))
-&gt; (Hash -&gt; Hash) -&gt; Hash -&gt; Transaction (Maybe ObjectId)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Hash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#hash1to2"><span class="hs-identifier hs-var">Cv.hash1to2</span></a></span><span>
</span><span id="line-543"></span><span id="declExists"><span class="annot"><span class="annottext">declExists :: Hash -&gt; Transaction Bool
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#declExists"><span class="hs-identifier hs-var hs-var">declExists</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Transaction Bool
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#termExists"><span class="hs-identifier hs-var">termExists</span></a></span><span>
</span><span id="line-544"></span><span>
</span><span id="line-545"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#before"><span class="hs-identifier hs-type">before</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Codebase.Causal.Type.html#CausalHash"><span class="hs-identifier hs-type">Branch.CausalHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Codebase.Causal.Type.html#CausalHash"><span class="hs-identifier hs-type">Branch.CausalHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>
</span><span id="line-546"></span><span id="before"><span class="annot"><span class="annottext">before :: CausalHash -&gt; CausalHash -&gt; Transaction (Maybe Bool)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#before"><span class="hs-identifier hs-var hs-var">before</span></a></span></span><span> </span><span id="local-6989586621680729256"><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621680729256"><span class="hs-identifier hs-var">h1</span></a></span></span><span> </span><span id="local-6989586621680729255"><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621680729255"><span class="hs-identifier hs-var">h2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-547"></span><span>  </span><span class="annot"><span class="annottext">CausalHash -&gt; CausalHash -&gt; Transaction (Maybe Bool)
</span><span class="hs-identifier hs-var">Ops.before</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CausalHash -&gt; CausalHash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#causalHash1to2"><span class="hs-identifier hs-var">Cv.causalHash1to2</span></a></span><span> </span><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621680729256"><span class="hs-identifier hs-var">h1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CausalHash -&gt; CausalHash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#causalHash1to2"><span class="hs-identifier hs-var">Cv.causalHash1to2</span></a></span><span> </span><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621680729255"><span class="hs-identifier hs-var">h2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-548"></span><span>
</span><span id="line-549"></span><span class="hs-comment">-- | Construct a 'ScopedNames' which can produce names which are relative to the provided</span><span>
</span><span id="line-550"></span><span class="hs-comment">-- Path.</span><span>
</span><span id="line-551"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#namesAtPath"><span class="hs-identifier hs-type">namesAtPath</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-552"></span><span>  </span><span class="annot"><a href="Unison.Codebase.Path.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-553"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ScopedNames</span></span><span>
</span><span id="line-554"></span><span id="namesAtPath"><span class="annot"><span class="annottext">namesAtPath :: Path -&gt; Transaction ScopedNames
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#namesAtPath"><span class="hs-identifier hs-var hs-var">namesAtPath</span></a></span></span><span> </span><span id="local-6989586621680729252"><span class="annot"><span class="annottext">Path
</span><a href="#local-6989586621680729252"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-555"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621680729251"><span class="annot"><span class="annottext">[NamedRef (Referent, Maybe ConstructorType)]
</span><a href="#local-6989586621680729251"><span class="hs-identifier hs-var">termNames</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680729250"><span class="annot"><span class="annottext">[NamedRef Reference]
</span><a href="#local-6989586621680729250"><span class="hs-identifier hs-var">typeNames</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Transaction
  ([NamedRef (Referent, Maybe ConstructorType)],
   [NamedRef Reference])
</span><span class="hs-identifier hs-var">Ops.rootBranchNames</span></span><span>
</span><span id="line-556"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680729248"><span class="hs-identifier hs-type">allTerms</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent.Referent</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-557"></span><span>      </span><span id="local-6989586621680729248"><span class="annot"><span class="annottext">allTerms :: [(Name, Referent)]
</span><a href="#local-6989586621680729248"><span class="hs-identifier hs-var hs-var">allTerms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-558"></span><span>        </span><span class="annot"><span class="annottext">[NamedRef (Referent, Maybe ConstructorType)]
</span><a href="#local-6989586621680729251"><span class="hs-identifier hs-var">termNames</span></a></span><span> </span><span class="annot"><span class="annottext">[NamedRef (Referent, Maybe ConstructorType)]
-&gt; (NamedRef (Referent, Maybe ConstructorType) -&gt; (Name, Referent))
-&gt; [(Name, Referent)]
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.NamedRef</span></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680729246"><span class="annot"><span class="annottext">ReversedSegments
$sel:reversedSegments:NamedRef :: forall ref. NamedRef ref -&gt; ReversedSegments
reversedSegments :: ReversedSegments
</span><span class="hs-identifier hs-var hs-var">reversedSegments</span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:ref:NamedRef :: forall ref. NamedRef ref -&gt; ref
</span><span class="hs-identifier hs-var">ref</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680729243"><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680729243"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680729242"><span class="annot"><span class="annottext">Maybe ConstructorType
</span><a href="#local-6989586621680729242"><span class="hs-identifier hs-var">ct</span></a></span></span><span class="hs-special">)</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-559"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680729241"><span class="annot"><span class="annottext">v1ref :: Referent
</span><a href="#local-6989586621680729241"><span class="hs-identifier hs-var hs-var">v1ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Identity Referent -&gt; Referent
forall a. Identity a -&gt; a
</span><span class="hs-identifier hs-var hs-var">runIdentity</span></span><span> </span><span class="annot"><span class="annottext">(Identity Referent -&gt; Referent) -&gt; Identity Referent -&gt; Referent
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Reference -&gt; Identity ConstructorType)
-&gt; Referent -&gt; Identity Referent
forall (m :: * -&gt; *).
Applicative m =&gt;
(Reference -&gt; m ConstructorType) -&gt; Referent -&gt; m Referent
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#referent2to1"><span class="hs-identifier hs-var">Cv.referent2to1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Identity ConstructorType -&gt; Reference -&gt; Identity ConstructorType
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">(Identity ConstructorType -&gt; Reference -&gt; Identity ConstructorType)
-&gt; (Maybe ConstructorType -&gt; Identity ConstructorType)
-&gt; Maybe ConstructorType
-&gt; Reference
-&gt; Identity ConstructorType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ConstructorType -&gt; Identity ConstructorType
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ConstructorType -&gt; Identity ConstructorType)
-&gt; (Maybe ConstructorType -&gt; ConstructorType)
-&gt; Maybe ConstructorType
-&gt; Identity ConstructorType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ConstructorType -&gt; ConstructorType
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#constructorType2to1"><span class="hs-identifier hs-var">Cv.constructorType2to1</span></a></span><span> </span><span class="annot"><span class="annottext">(ConstructorType -&gt; ConstructorType)
-&gt; (Maybe ConstructorType -&gt; ConstructorType)
-&gt; Maybe ConstructorType
-&gt; ConstructorType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ConstructorType -&gt; Maybe ConstructorType -&gt; ConstructorType
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; ConstructorType
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Required constructor type for constructor but it was null&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe ConstructorType -&gt; Reference -&gt; Identity ConstructorType)
-&gt; Maybe ConstructorType -&gt; Reference -&gt; Identity ConstructorType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe ConstructorType
</span><a href="#local-6989586621680729242"><span class="hs-identifier hs-var">ct</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680729243"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-560"></span><span>           </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty NameSegment -&gt; Name
</span><span class="hs-identifier hs-var">Name.fromReverseSegments</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ReversedSegments -&gt; NonEmpty NameSegment
</span><span class="hs-identifier hs-var">coerce</span></span><span> </span><span class="annot"><span class="annottext">ReversedSegments
</span><a href="#local-6989586621680729246"><span class="hs-identifier hs-var">reversedSegments</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680729241"><span class="hs-identifier hs-var">v1ref</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-561"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680729236"><span class="hs-identifier hs-type">allTypes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Reference</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-562"></span><span>      </span><span id="local-6989586621680729236"><span class="annot"><span class="annottext">allTypes :: [(Name, Reference)]
</span><a href="#local-6989586621680729236"><span class="hs-identifier hs-var hs-var">allTypes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-563"></span><span>        </span><span class="annot"><span class="annottext">[NamedRef Reference]
</span><a href="#local-6989586621680729250"><span class="hs-identifier hs-var">typeNames</span></a></span><span> </span><span class="annot"><span class="annottext">[NamedRef Reference]
-&gt; (NamedRef Reference -&gt; (Name, Reference)) -&gt; [(Name, Reference)]
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.NamedRef</span></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680729235"><span class="annot"><span class="annottext">ReversedSegments
reversedSegments :: ReversedSegments
$sel:reversedSegments:NamedRef :: forall ref. NamedRef ref -&gt; ReversedSegments
</span><a href="#local-6989586621680729235"><span class="hs-identifier hs-var hs-var">reversedSegments</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680729234"><span class="annot"><span class="annottext">Reference
ref :: Reference
$sel:ref:NamedRef :: forall ref. NamedRef ref -&gt; ref
</span><a href="#local-6989586621680729234"><span class="hs-identifier hs-var hs-var">ref</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-564"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty NameSegment -&gt; Name
</span><span class="hs-identifier hs-var">Name.fromReverseSegments</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ReversedSegments -&gt; NonEmpty NameSegment
</span><span class="hs-identifier hs-var">coerce</span></span><span> </span><span class="annot"><span class="annottext">ReversedSegments
</span><a href="#local-6989586621680729235"><span class="hs-identifier hs-var">reversedSegments</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Reference -&gt; Reference
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#reference2to1"><span class="hs-identifier hs-var">Cv.reference2to1</span></a></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621680729234"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-565"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680729232"><span class="annot"><span class="annottext">rootTerms :: Relation Name Referent
</span><a href="#local-6989586621680729232"><span class="hs-identifier hs-var hs-var">rootTerms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Name, Referent)] -&gt; Relation Name Referent
forall a b. (Ord a, Ord b) =&gt; [(a, b)] -&gt; Relation a b
</span><span class="hs-identifier hs-var">Rel.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(Name, Referent)]
</span><a href="#local-6989586621680729248"><span class="hs-identifier hs-var">allTerms</span></a></span><span>
</span><span id="line-566"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680729230"><span class="annot"><span class="annottext">rootTypes :: Relation Name Reference
</span><a href="#local-6989586621680729230"><span class="hs-identifier hs-var hs-var">rootTypes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Name, Reference)] -&gt; Relation Name Reference
forall a b. (Ord a, Ord b) =&gt; [(a, b)] -&gt; Relation a b
</span><span class="hs-identifier hs-var">Rel.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(Name, Reference)]
</span><a href="#local-6989586621680729236"><span class="hs-identifier hs-var">allTypes</span></a></span><span>
</span><span id="line-567"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680729229"><span class="annot"><span class="annottext">absoluteRootNames :: Names
</span><a href="#local-6989586621680729229"><span class="hs-identifier hs-var hs-var">absoluteRootNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names :: Relation Name Referent -&gt; Relation Name Reference -&gt; Names
</span><span class="hs-identifier hs-type">Names</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">terms :: Relation Name Referent
</span><span class="hs-identifier hs-var">terms</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Relation Name Referent
</span><a href="#local-6989586621680729232"><span class="hs-identifier hs-var">rootTerms</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">types :: Relation Name Reference
</span><span class="hs-identifier hs-var">types</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Relation Name Reference
</span><a href="#local-6989586621680729230"><span class="hs-identifier hs-var">rootTypes</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-568"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680729226"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621680729226"><span class="hs-identifier hs-var">relativeScopedNames</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680729225"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621680729225"><span class="hs-identifier hs-var">absoluteExternalNames</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-569"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Path
</span><a href="#local-6989586621680729252"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-570"></span><span>          </span><span class="annot"><span class="annottext">Path
</span><a href="Unison.Codebase.Path.html#Empty"><span class="hs-identifier hs-var">Path.Empty</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621680729229"><span class="hs-identifier hs-var">absoluteRootNames</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-571"></span><span>          </span><span id="local-6989586621680729223"><span class="annot"><span class="annottext">Path
</span><a href="#local-6989586621680729223"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-572"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680729222"><span class="annot"><span class="annottext">reversedPathSegments :: [NameSegment]
</span><a href="#local-6989586621680729222"><span class="hs-identifier hs-var hs-var">reversedPathSegments</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[NameSegment] -&gt; [NameSegment]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">([NameSegment] -&gt; [NameSegment])
-&gt; (Path -&gt; [NameSegment]) -&gt; Path -&gt; [NameSegment]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Path -&gt; [NameSegment]
</span><a href="Unison.Codebase.Path.html#toList"><span class="hs-identifier hs-var">Path.toList</span></a></span><span> </span><span class="annot"><span class="annottext">(Path -&gt; [NameSegment]) -&gt; Path -&gt; [NameSegment]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Path
</span><a href="#local-6989586621680729223"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-573"></span><span>                </span><span class="hs-special">(</span><span id="local-6989586621680729219"><span class="annot"><span class="annottext">[(Name, Referent)]
</span><a href="#local-6989586621680729219"><span class="hs-identifier hs-var">relativeTerms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680729218"><span class="annot"><span class="annottext">[(Name, Referent)]
</span><a href="#local-6989586621680729218"><span class="hs-identifier hs-var">externalTerms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Name, Referent) -&gt; ([(Name, Referent)], [(Name, Referent)]))
-&gt; [(Name, Referent)] -&gt; ([(Name, Referent)], [(Name, Referent)])
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[NameSegment]
-&gt; (Name, Referent) -&gt; ([(Name, Referent)], [(Name, Referent)])
forall r. [NameSegment] -&gt; (Name, r) -&gt; ([(Name, r)], [(Name, r)])
</span><a href="#local-6989586621680729216"><span class="hs-identifier hs-var">partitionByPathPrefix</span></a></span><span> </span><span class="annot"><span class="annottext">[NameSegment]
</span><a href="#local-6989586621680729222"><span class="hs-identifier hs-var">reversedPathSegments</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, Referent)]
</span><a href="#local-6989586621680729248"><span class="hs-identifier hs-var">allTerms</span></a></span><span>
</span><span id="line-574"></span><span>                </span><span class="hs-special">(</span><span id="local-6989586621680729215"><span class="annot"><span class="annottext">[(Name, Reference)]
</span><a href="#local-6989586621680729215"><span class="hs-identifier hs-var">relativeTypes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680729214"><span class="annot"><span class="annottext">[(Name, Reference)]
</span><a href="#local-6989586621680729214"><span class="hs-identifier hs-var">externalTypes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Name, Reference) -&gt; ([(Name, Reference)], [(Name, Reference)]))
-&gt; [(Name, Reference)]
-&gt; ([(Name, Reference)], [(Name, Reference)])
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[NameSegment]
-&gt; (Name, Reference) -&gt; ([(Name, Reference)], [(Name, Reference)])
forall r. [NameSegment] -&gt; (Name, r) -&gt; ([(Name, r)], [(Name, r)])
</span><a href="#local-6989586621680729216"><span class="hs-identifier hs-var">partitionByPathPrefix</span></a></span><span> </span><span class="annot"><span class="annottext">[NameSegment]
</span><a href="#local-6989586621680729222"><span class="hs-identifier hs-var">reversedPathSegments</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, Reference)]
</span><a href="#local-6989586621680729236"><span class="hs-identifier hs-var">allTypes</span></a></span><span>
</span><span id="line-575"></span><span>             </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Names :: Relation Name Referent -&gt; Relation Name Reference -&gt; Names
</span><span class="hs-identifier hs-type">Names</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">terms :: Relation Name Referent
</span><span class="hs-identifier hs-var">terms</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Name, Referent)] -&gt; Relation Name Referent
forall a b. (Ord a, Ord b) =&gt; [(a, b)] -&gt; Relation a b
</span><span class="hs-identifier hs-var">Rel.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(Name, Referent)]
</span><a href="#local-6989586621680729219"><span class="hs-identifier hs-var">relativeTerms</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">types :: Relation Name Reference
</span><span class="hs-identifier hs-var">types</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Name, Reference)] -&gt; Relation Name Reference
forall a b. (Ord a, Ord b) =&gt; [(a, b)] -&gt; Relation a b
</span><span class="hs-identifier hs-var">Rel.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(Name, Reference)]
</span><a href="#local-6989586621680729215"><span class="hs-identifier hs-var">relativeTypes</span></a></span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-576"></span><span>                  </span><span class="annot"><span class="annottext">Names :: Relation Name Referent -&gt; Relation Name Reference -&gt; Names
</span><span class="hs-identifier hs-type">Names</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">terms :: Relation Name Referent
</span><span class="hs-identifier hs-var">terms</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Name, Referent)] -&gt; Relation Name Referent
forall a b. (Ord a, Ord b) =&gt; [(a, b)] -&gt; Relation a b
</span><span class="hs-identifier hs-var">Rel.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(Name, Referent)]
</span><a href="#local-6989586621680729218"><span class="hs-identifier hs-var">externalTerms</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">types :: Relation Name Reference
</span><span class="hs-identifier hs-var">types</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Name, Reference)] -&gt; Relation Name Reference
forall a b. (Ord a, Ord b) =&gt; [(a, b)] -&gt; Relation a b
</span><span class="hs-identifier hs-var">Rel.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(Name, Reference)]
</span><a href="#local-6989586621680729214"><span class="hs-identifier hs-var">externalTypes</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-577"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-578"></span><span>  </span><span class="annot"><span class="annottext">ScopedNames -&gt; Transaction ScopedNames
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ScopedNames -&gt; Transaction ScopedNames)
-&gt; ScopedNames -&gt; Transaction ScopedNames
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-579"></span><span>    </span><span class="annot"><span class="annottext">ScopedNames :: Names -&gt; Names -&gt; Names -&gt; ScopedNames
</span><span class="hs-identifier hs-type">ScopedNames</span></span><span>
</span><span id="line-580"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Names
absoluteExternalNames :: Names
absoluteExternalNames :: Names
</span><span class="hs-identifier hs-var hs-var">absoluteExternalNames</span></span><span class="hs-special">,</span><span>
</span><span id="line-581"></span><span>        </span><span class="annot"><span class="annottext">Names
relativeScopedNames :: Names
relativeScopedNames :: Names
</span><span class="hs-identifier hs-var hs-var">relativeScopedNames</span></span><span class="hs-special">,</span><span>
</span><span id="line-582"></span><span>        </span><span class="annot"><span class="annottext">Names
absoluteRootNames :: Names
absoluteRootNames :: Names
</span><span class="hs-identifier hs-var hs-var">absoluteRootNames</span></span><span>
</span><span id="line-583"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-584"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-585"></span><span>    </span><span class="hs-comment">-- If the given prefix matches the given name, the prefix is stripped and it's collected</span><span>
</span><span id="line-586"></span><span>    </span><span class="hs-comment">-- on the left, otherwise it's left as-is and collected on the right.</span><span>
</span><span id="line-587"></span><span>    </span><span class="hs-comment">-- &gt;&gt;&gt; partitionByPathPrefix [&quot;b&quot;, &quot;a&quot;] (&quot;a.b.c&quot;, ())</span><span>
</span><span id="line-588"></span><span>    </span><span class="hs-comment">-- ([(c,())],[])</span><span>
</span><span id="line-589"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-590"></span><span>    </span><span class="hs-comment">-- &gt;&gt;&gt; partitionByPathPrefix [&quot;y&quot;, &quot;x&quot;] (&quot;a.b.c&quot;, ())</span><span>
</span><span id="line-591"></span><span>    </span><span class="hs-comment">-- ([],[(a.b.c,())])</span><span>
</span><span id="line-592"></span><span>    </span><span id="local-6989586621680729707"><span class="annot"><a href="#local-6989586621680729216"><span class="hs-identifier hs-type">partitionByPathPrefix</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">NameSegment</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621680729707"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621680729707"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621680729707"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-593"></span><span>    </span><span id="local-6989586621680729216"><span class="annot"><span class="annottext">partitionByPathPrefix :: [NameSegment] -&gt; (Name, r) -&gt; ([(Name, r)], [(Name, r)])
</span><a href="#local-6989586621680729216"><span class="hs-identifier hs-var hs-var">partitionByPathPrefix</span></a></span></span><span> </span><span id="local-6989586621680729209"><span class="annot"><span class="annottext">[NameSegment]
</span><a href="#local-6989586621680729209"><span class="hs-identifier hs-var">reversedPathSegments</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680729208"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680729208"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680729207"><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621680729207"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-594"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Name -&gt; [NameSegment] -&gt; Maybe Name
</span><span class="hs-identifier hs-var">Name.stripReversedPrefix</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680729208"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">[NameSegment]
</span><a href="#local-6989586621680729209"><span class="hs-identifier hs-var">reversedPathSegments</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-595"></span><span>        </span><span class="annot"><span class="annottext">Maybe Name
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Name, r)]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680729208"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621680729207"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-596"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680729205"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680729205"><span class="hs-identifier hs-var">stripped</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Name
</span><span class="hs-identifier hs-var">Name.makeRelative</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680729205"><span class="hs-identifier hs-var">stripped</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621680729207"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Name, r)]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-597"></span><span>
</span><span id="line-598"></span><span class="hs-comment">-- | Update the root namespace names index which is used by the share server for serving api</span><span>
</span><span id="line-599"></span><span class="hs-comment">-- requests.</span><span>
</span><span id="line-600"></span><span class="hs-comment">--</span><span>
</span><span id="line-601"></span><span class="hs-comment">-- This version should be used if you've already got the root Branch pre-loaded, otherwise</span><span>
</span><span id="line-602"></span><span class="hs-comment">-- it's faster to use 'updateNameLookupIndexFromV2Branch'</span><span>
</span><span id="line-603"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#updateNameLookupIndexFromV1Branch"><span class="hs-identifier hs-type">updateNameLookupIndexFromV1Branch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Codebase.Branch.Type.html#Branch"><span class="hs-identifier hs-type">Branch</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-604"></span><span id="updateNameLookupIndexFromV1Branch"><span class="annot"><span class="annottext">updateNameLookupIndexFromV1Branch :: Branch Transaction -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#updateNameLookupIndexFromV1Branch"><span class="hs-identifier hs-var hs-var">updateNameLookupIndexFromV1Branch</span></a></span></span><span> </span><span id="local-6989586621680729202"><span class="annot"><span class="annottext">Branch Transaction
</span><a href="#local-6989586621680729202"><span class="hs-identifier hs-var">root</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-605"></span><span>  </span><span class="annot"><span class="annottext">Names -&gt; Transaction ()
</span><a href="#local-6989586621680729201"><span class="hs-identifier hs-var">saveRootNamesIndexV1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Branch0 Transaction -&gt; Names
forall (m :: * -&gt; *). Branch0 m -&gt; Names
</span><a href="Unison.Codebase.Branch.Names.html#toNames"><span class="hs-identifier hs-var">V1Branch.toNames</span></a></span><span> </span><span class="annot"><span class="annottext">(Branch0 Transaction -&gt; Names)
-&gt; (Branch Transaction -&gt; Branch0 Transaction)
-&gt; Branch Transaction
-&gt; Names
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Branch Transaction -&gt; Branch0 Transaction
forall (m :: * -&gt; *). Branch m -&gt; Branch0 m
</span><a href="Unison.Codebase.Branch.Type.html#head"><span class="hs-identifier hs-var">Branch.head</span></a></span><span> </span><span class="annot"><span class="annottext">(Branch Transaction -&gt; Names) -&gt; Branch Transaction -&gt; Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Branch Transaction
</span><a href="#local-6989586621680729202"><span class="hs-identifier hs-var">root</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-606"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-607"></span><span>    </span><span class="annot"><a href="#local-6989586621680729201"><span class="hs-identifier hs-type">saveRootNamesIndexV1</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Names</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-608"></span><span>    </span><span id="local-6989586621680729201"><span class="annot"><span class="annottext">saveRootNamesIndexV1 :: Names -&gt; Transaction ()
</span><a href="#local-6989586621680729201"><span class="hs-identifier hs-var hs-var">saveRootNamesIndexV1</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Names</span></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680729198"><span class="annot"><span class="annottext">Relation Name Referent
terms :: Relation Name Referent
terms :: Names -&gt; Relation Name Referent
</span><a href="#local-6989586621680729198"><span class="hs-identifier hs-var hs-var">Names.terms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680729197"><span class="annot"><span class="annottext">Relation Name Reference
types :: Relation Name Reference
types :: Names -&gt; Relation Name Reference
</span><a href="#local-6989586621680729197"><span class="hs-identifier hs-var hs-var">Names.types</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-609"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680729196"><span class="hs-identifier hs-type">termNames</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.NamedRef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Referent.Referent</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Referent.ConstructorType</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-610"></span><span>          </span><span id="local-6989586621680729196"><span class="annot"><span class="annottext">termNames :: [NamedRef (Referent, Maybe ConstructorType)]
</span><a href="#local-6989586621680729196"><span class="hs-identifier hs-var hs-var">termNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Relation Name Referent -&gt; [(Name, Referent)]
forall a b. Relation a b -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">Rel.toList</span></span><span> </span><span class="annot"><span class="annottext">Relation Name Referent
</span><a href="#local-6989586621680729198"><span class="hs-identifier hs-var">terms</span></a></span><span> </span><span class="annot"><span class="annottext">[(Name, Referent)]
-&gt; ((Name, Referent) -&gt; NamedRef (Referent, Maybe ConstructorType))
-&gt; [NamedRef (Referent, Maybe ConstructorType)]
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680729194"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680729194"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680729193"><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680729193"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">NamedRef :: forall ref. ReversedSegments -&gt; ref -&gt; NamedRef ref
</span><span class="hs-identifier hs-type">S.NamedRef</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:reversedSegments:NamedRef :: ReversedSegments
</span><span class="hs-identifier hs-var">reversedSegments</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; ReversedSegments
</span><a href="#local-6989586621680729192"><span class="hs-identifier hs-var">nameSegments</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680729194"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:ref:NamedRef :: (Referent, Maybe ConstructorType)
</span><span class="hs-identifier hs-var">ref</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Referent -&gt; (Referent, Maybe ConstructorType)
</span><a href="#local-6989586621680729191"><span class="hs-identifier hs-var">splitReferent</span></a></span><span> </span><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680729193"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-611"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680729190"><span class="hs-identifier hs-type">typeNames</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.NamedRef</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-612"></span><span>          </span><span id="local-6989586621680729190"><span class="annot"><span class="annottext">typeNames :: [NamedRef Reference]
</span><a href="#local-6989586621680729190"><span class="hs-identifier hs-var hs-var">typeNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-613"></span><span>            </span><span class="annot"><span class="annottext">Relation Name Reference -&gt; [(Name, Reference)]
forall a b. Relation a b -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">Rel.toList</span></span><span> </span><span class="annot"><span class="annottext">Relation Name Reference
</span><a href="#local-6989586621680729197"><span class="hs-identifier hs-var">types</span></a></span><span>
</span><span id="line-614"></span><span>              </span><span class="annot"><span class="annottext">[(Name, Reference)]
-&gt; ((Name, Reference) -&gt; NamedRef Reference)
-&gt; [NamedRef Reference]
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680729189"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680729189"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680729188"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621680729188"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-615"></span><span>                      </span><span class="annot"><span class="annottext">NamedRef :: forall ref. ReversedSegments -&gt; ref -&gt; NamedRef ref
</span><span class="hs-identifier hs-type">S.NamedRef</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:reversedSegments:NamedRef :: ReversedSegments
</span><span class="hs-identifier hs-var">reversedSegments</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; ReversedSegments
</span><a href="#local-6989586621680729192"><span class="hs-identifier hs-var">nameSegments</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680729189"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:ref:NamedRef :: Reference
</span><span class="hs-identifier hs-var">ref</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Reference -&gt; Reference
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#reference1to2"><span class="hs-identifier hs-var">Cv.reference1to2</span></a></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621680729188"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-616"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-617"></span><span>      </span><span class="annot"><span class="annottext">[NamedRef (Referent, Maybe ConstructorType)]
-&gt; [NamedRef Reference] -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Ops.rebuildNameIndex</span></span><span> </span><span class="annot"><span class="annottext">[NamedRef (Referent, Maybe ConstructorType)]
</span><a href="#local-6989586621680729196"><span class="hs-identifier hs-var">termNames</span></a></span><span> </span><span class="annot"><span class="annottext">[NamedRef Reference]
</span><a href="#local-6989586621680729190"><span class="hs-identifier hs-var">typeNames</span></a></span><span>
</span><span id="line-618"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-619"></span><span>        </span><span class="annot"><a href="#local-6989586621680729192"><span class="hs-identifier hs-type">nameSegments</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NonEmpty</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-620"></span><span>        </span><span id="local-6989586621680729192"><span class="annot"><span class="annottext">nameSegments :: Name -&gt; ReversedSegments
</span><a href="#local-6989586621680729192"><span class="hs-identifier hs-var hs-var">nameSegments</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Coercible (NonEmpty NameSegment) ReversedSegments =&gt;
NonEmpty NameSegment -&gt; ReversedSegments
</span><span class="hs-identifier hs-var">coerce</span></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">NonEmpty</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">NameSegment</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">NonEmpty</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(NonEmpty NameSegment -&gt; ReversedSegments)
-&gt; (Name -&gt; NonEmpty NameSegment) -&gt; Name -&gt; ReversedSegments
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; NonEmpty NameSegment
</span><span class="hs-identifier hs-var">Name.reverseSegments</span></span><span>
</span><span id="line-621"></span><span>        </span><span class="annot"><a href="#local-6989586621680729191"><span class="hs-identifier hs-type">splitReferent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent.Referent</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Referent.Referent</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Referent.ConstructorType</span></span><span class="hs-special">)</span><span>
</span><span id="line-622"></span><span>        </span><span id="local-6989586621680729191"><span class="annot"><span class="annottext">splitReferent :: Referent -&gt; (Referent, Maybe ConstructorType)
</span><a href="#local-6989586621680729191"><span class="hs-identifier hs-var hs-var">splitReferent</span></a></span></span><span> </span><span id="local-6989586621680729185"><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680729185"><span class="hs-identifier hs-var">referent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680729185"><span class="hs-identifier hs-var">referent</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-623"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Referent.Ref</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Referent -&gt; Referent
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#referent1to2"><span class="hs-identifier hs-var">Cv.referent1to2</span></a></span><span> </span><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680729185"><span class="hs-identifier hs-var">referent</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe ConstructorType
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-624"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Referent.Con</span></span><span> </span><span id="local-6989586621680729181"><span class="annot"><span class="annottext">ConstructorReference
</span><a href="#local-6989586621680729181"><span class="hs-identifier hs-var">_ref</span></a></span></span><span> </span><span id="local-6989586621680729180"><span class="annot"><span class="annottext">ConstructorType
</span><a href="#local-6989586621680729180"><span class="hs-identifier hs-var">ct</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Referent -&gt; Referent
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#referent1to2"><span class="hs-identifier hs-var">Cv.referent1to2</span></a></span><span> </span><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680729185"><span class="hs-identifier hs-var">referent</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConstructorType -&gt; Maybe ConstructorType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConstructorType -&gt; ConstructorType
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#constructorType1to2"><span class="hs-identifier hs-var">Cv.constructorType1to2</span></a></span><span> </span><span class="annot"><span class="annottext">ConstructorType
</span><a href="#local-6989586621680729180"><span class="hs-identifier hs-var">ct</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-625"></span><span>
</span><span id="line-626"></span><span class="hs-comment">-- | Update the root namespace names index which is used by the share server for serving api</span><span>
</span><span id="line-627"></span><span class="hs-comment">-- requests.</span><span>
</span><span id="line-628"></span><span class="hs-comment">--</span><span>
</span><span id="line-629"></span><span class="hs-comment">-- This version should be used if you don't already have the root Branch pre-loaded,</span><span>
</span><span id="line-630"></span><span class="hs-comment">-- If you do, use 'updateNameLookupIndexFromV2Branch' instead.</span><span>
</span><span id="line-631"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#updateNameLookupIndexFromV2Root"><span class="hs-identifier hs-type">updateNameLookupIndexFromV2Root</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-632"></span><span id="updateNameLookupIndexFromV2Root"><span class="annot"><span class="annottext">updateNameLookupIndexFromV2Root :: (Reference -&gt; Transaction ConstructorType) -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#updateNameLookupIndexFromV2Root"><span class="hs-identifier hs-var hs-var">updateNameLookupIndexFromV2Root</span></a></span></span><span> </span><span id="local-6989586621680729177"><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680729177"><span class="hs-identifier hs-var">getDeclType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-633"></span><span>  </span><span id="local-6989586621680729176"><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621680729176"><span class="hs-identifier hs-var">rootHash</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Transaction CausalHash
</span><span class="hs-identifier hs-var">Ops.expectRootCausalHash</span></span><span>
</span><span id="line-634"></span><span>  </span><span id="local-6989586621680729175"><span class="annot"><span class="annottext">CausalBranch Transaction
</span><a href="#local-6989586621680729175"><span class="hs-identifier hs-var">causalBranch</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CausalHash -&gt; Transaction (CausalBranch Transaction)
</span><span class="hs-identifier hs-var">Ops.expectCausalBranchByCausalHash</span></span><span> </span><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621680729176"><span class="hs-identifier hs-var">rootHash</span></a></span><span>
</span><span id="line-635"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621680729173"><span class="annot"><span class="annottext">Map (NonEmpty NameSegment) (Set Referent)
</span><a href="#local-6989586621680729173"><span class="hs-identifier hs-var">termNameMap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680729172"><span class="annot"><span class="annottext">Map (NonEmpty NameSegment) (Set Reference)
</span><a href="#local-6989586621680729172"><span class="hs-identifier hs-var">typeNameMap</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[NameSegment]
-&gt; CausalBranch Transaction
-&gt; Transaction
     (Map (NonEmpty NameSegment) (Set Referent),
      Map (NonEmpty NameSegment) (Set Reference))
forall (m :: * -&gt; *).
Monad m =&gt;
[NameSegment]
-&gt; CausalBranch m
-&gt; m (Map (NonEmpty NameSegment) (Set Referent),
      Map (NonEmpty NameSegment) (Set Reference))
</span><a href="#local-6989586621680729171"><span class="hs-identifier hs-var">nameMapsFromV2Branch</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">CausalBranch Transaction
</span><a href="#local-6989586621680729175"><span class="hs-identifier hs-var">causalBranch</span></a></span><span>
</span><span id="line-636"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680729170"><span class="annot"><span class="annottext">expandedTermNames :: [(NonEmpty NameSegment, Referent)]
</span><a href="#local-6989586621680729170"><span class="hs-identifier hs-var hs-var">expandedTermNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map (NonEmpty NameSegment) (Set Referent)
-&gt; [(NonEmpty NameSegment, Set Referent)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span> </span><span class="annot"><span class="annottext">Map (NonEmpty NameSegment) (Set Referent)
</span><a href="#local-6989586621680729173"><span class="hs-identifier hs-var">termNameMap</span></a></span><span> </span><span class="annot"><span class="annottext">[(NonEmpty NameSegment, Set Referent)]
-&gt; ((NonEmpty NameSegment, Set Referent)
    -&gt; [(NonEmpty NameSegment, Referent)])
-&gt; [(NonEmpty NameSegment, Referent)]
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680729169"><span class="annot"><span class="annottext">NonEmpty NameSegment
</span><a href="#local-6989586621680729169"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680729168"><span class="annot"><span class="annottext">Set Referent
</span><a href="#local-6989586621680729168"><span class="hs-identifier hs-var">refs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty NameSegment
</span><a href="#local-6989586621680729169"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Referent -&gt; (NonEmpty NameSegment, Referent))
-&gt; [Referent] -&gt; [(NonEmpty NameSegment, Referent)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Set Referent -&gt; [Referent]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">Set Referent
</span><a href="#local-6989586621680729168"><span class="hs-identifier hs-var">refs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-637"></span><span>  </span><span id="local-6989586621680729167"><span class="annot"><span class="annottext">[NamedRef (Referent, Maybe ConstructorType)]
</span><a href="#local-6989586621680729167"><span class="hs-identifier hs-var">termNameList</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-638"></span><span>    </span><span class="annot"><span class="annottext">[(NonEmpty NameSegment, Referent)]
-&gt; ((NonEmpty NameSegment, Referent)
    -&gt; Transaction (NamedRef (Referent, Maybe ConstructorType)))
-&gt; Transaction [NamedRef (Referent, Maybe ConstructorType)]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f (t b)
</span><span class="hs-identifier hs-var">for</span></span><span> </span><span class="annot"><span class="annottext">[(NonEmpty NameSegment, Referent)]
</span><a href="#local-6989586621680729170"><span class="hs-identifier hs-var">expandedTermNames</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680729166"><span class="annot"><span class="annottext">NonEmpty NameSegment
</span><a href="#local-6989586621680729166"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680729165"><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680729165"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-639"></span><span>      </span><span id="local-6989586621680729164"><span class="annot"><span class="annottext">(Referent, Maybe ConstructorType)
</span><a href="#local-6989586621680729164"><span class="hs-identifier hs-var">refWithCT</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Referent -&gt; Transaction (Referent, Maybe ConstructorType)
</span><a href="#local-6989586621680729163"><span class="hs-identifier hs-var">addReferentCT</span></a></span><span> </span><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680729165"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-640"></span><span>      </span><span class="hs-identifier">pure</span><span> </span><span class="annot"><span class="annottext">NamedRef :: forall ref. ReversedSegments -&gt; ref -&gt; NamedRef ref
</span><span class="hs-identifier hs-type">S.NamedRef</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:reversedSegments:NamedRef :: ReversedSegments
</span><span class="hs-identifier hs-var">S.reversedSegments</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonEmpty NameSegment -&gt; ReversedSegments
</span><span class="hs-identifier hs-var">coerce</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty NameSegment
</span><a href="#local-6989586621680729166"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:ref:NamedRef :: (Referent, Maybe ConstructorType)
</span><span class="hs-identifier hs-var">S.ref</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Referent, Maybe ConstructorType)
</span><a href="#local-6989586621680729164"><span class="hs-identifier hs-var">refWithCT</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-641"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680729162"><span class="annot"><span class="annottext">typeNameList :: [NamedRef Reference]
</span><a href="#local-6989586621680729162"><span class="hs-identifier hs-var hs-var">typeNameList</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-642"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621680729161"><span class="annot"><span class="annottext">NonEmpty NameSegment
</span><a href="#local-6989586621680729161"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680729160"><span class="annot"><span class="annottext">Set Reference
</span><a href="#local-6989586621680729160"><span class="hs-identifier hs-var">refs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map (NonEmpty NameSegment) (Set Reference)
-&gt; [(NonEmpty NameSegment, Set Reference)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span> </span><span class="annot"><span class="annottext">Map (NonEmpty NameSegment) (Set Reference)
</span><a href="#local-6989586621680729172"><span class="hs-identifier hs-var">typeNameMap</span></a></span><span>
</span><span id="line-643"></span><span>        </span><span id="local-6989586621680729159"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621680729159"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Set Reference -&gt; [Reference]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">Set Reference
</span><a href="#local-6989586621680729160"><span class="hs-identifier hs-var">refs</span></a></span><span>
</span><span id="line-644"></span><span>        </span><span class="hs-identifier">pure</span><span> </span><span class="hs-operator">$</span><span> </span><span class="annot"><span class="annottext">NamedRef :: forall ref. ReversedSegments -&gt; ref -&gt; NamedRef ref
</span><span class="hs-identifier hs-type">S.NamedRef</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:reversedSegments:NamedRef :: ReversedSegments
</span><span class="hs-identifier hs-var">S.reversedSegments</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonEmpty NameSegment -&gt; ReversedSegments
</span><span class="hs-identifier hs-var">coerce</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty NameSegment
</span><a href="#local-6989586621680729161"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:ref:NamedRef :: Reference
</span><span class="hs-identifier hs-var">S.ref</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621680729159"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-645"></span><span>  </span><span class="annot"><span class="annottext">[NamedRef (Referent, Maybe ConstructorType)]
-&gt; [NamedRef Reference] -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Ops.rebuildNameIndex</span></span><span> </span><span class="annot"><span class="annottext">[NamedRef (Referent, Maybe ConstructorType)]
</span><a href="#local-6989586621680729167"><span class="hs-identifier hs-var">termNameList</span></a></span><span> </span><span class="annot"><span class="annottext">[NamedRef Reference]
</span><a href="#local-6989586621680729162"><span class="hs-identifier hs-var">typeNameList</span></a></span><span>
</span><span id="line-646"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-647"></span><span>    </span><span class="annot"><a href="#local-6989586621680729163"><span class="hs-identifier hs-type">addReferentCT</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Referent.Referent</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Referent.Referent</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Referent.ConstructorType</span></span><span class="hs-special">)</span><span>
</span><span id="line-648"></span><span>    </span><span id="local-6989586621680729163"><span class="annot"><span class="annottext">addReferentCT :: Referent -&gt; Transaction (Referent, Maybe ConstructorType)
</span><a href="#local-6989586621680729163"><span class="hs-identifier hs-var hs-var">addReferentCT</span></a></span></span><span> </span><span id="local-6989586621680729158"><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680729158"><span class="hs-identifier hs-var">referent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680729158"><span class="hs-identifier hs-var">referent</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-649"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">C.Referent.Ref</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Referent, Maybe ConstructorType)
-&gt; Transaction (Referent, Maybe ConstructorType)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680729158"><span class="hs-identifier hs-var">referent</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe ConstructorType
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-650"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">C.Referent.Con</span></span><span> </span><span id="local-6989586621680729155"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621680729155"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span id="local-6989586621680729154"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680729154"><span class="hs-identifier hs-var">_conId</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-651"></span><span>        </span><span id="local-6989586621680729153"><span class="annot"><span class="annottext">ConstructorType
</span><a href="#local-6989586621680729153"><span class="hs-identifier hs-var">ct</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680729177"><span class="hs-identifier hs-var">getDeclType</span></a></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621680729155"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-652"></span><span>        </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680729158"><span class="hs-identifier hs-var">referent</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConstructorType -&gt; Maybe ConstructorType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ConstructorType -&gt; Maybe ConstructorType)
-&gt; ConstructorType -&gt; Maybe ConstructorType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConstructorType -&gt; ConstructorType
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#constructorType1to2"><span class="hs-identifier hs-var">Cv.constructorType1to2</span></a></span><span> </span><span class="annot"><span class="annottext">ConstructorType
</span><a href="#local-6989586621680729153"><span class="hs-identifier hs-var">ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-653"></span><span>
</span><span id="line-654"></span><span>    </span><span class="hs-comment">-- Traverse a v2 branch</span><span>
</span><span id="line-655"></span><span>    </span><span class="hs-comment">-- Collects two maps, one with all term names and one with all type names.</span><span>
</span><span id="line-656"></span><span>    </span><span class="hs-comment">-- Note that unlike the `Name` type in `unison-core1`, this list of name segments is</span><span>
</span><span id="line-657"></span><span>    </span><span class="hs-comment">-- in reverse order, e.g. `[&quot;map&quot;, &quot;List&quot;, &quot;base&quot;]`</span><span>
</span><span id="line-658"></span><span>    </span><span id="local-6989586621680729697"><span class="annot"><a href="#local-6989586621680729171"><span class="hs-identifier hs-type">nameMapsFromV2Branch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621680729697"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">V2Branch.NameSegment</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">V2Branch.CausalBranch</span></span><span> </span><span class="annot"><a href="#local-6989586621680729697"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680729697"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">NonEmpty</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">V2Branch.NameSegment</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Referent.Referent</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">NonEmpty</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">V2Branch.NameSegment</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-659"></span><span>    </span><span id="local-6989586621680729171"><span class="annot"><span class="annottext">nameMapsFromV2Branch :: [NameSegment]
-&gt; CausalBranch m
-&gt; m (Map (NonEmpty NameSegment) (Set Referent),
      Map (NonEmpty NameSegment) (Set Reference))
</span><a href="#local-6989586621680729171"><span class="hs-identifier hs-var hs-var">nameMapsFromV2Branch</span></a></span></span><span> </span><span id="local-6989586621680729152"><span class="annot"><span class="annottext">[NameSegment]
</span><a href="#local-6989586621680729152"><span class="hs-identifier hs-var">reversedNamePrefix</span></a></span></span><span> </span><span id="local-6989586621680729151"><span class="annot"><span class="annottext">CausalBranch m
</span><a href="#local-6989586621680729151"><span class="hs-identifier hs-var">cb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-660"></span><span>      </span><span id="local-6989586621680729150"><span class="annot"><span class="annottext">Branch m
</span><a href="#local-6989586621680729150"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CausalBranch m -&gt; m (Branch m)
forall (m :: * -&gt; *) hc he e. Causal m hc he e -&gt; m e
</span><span class="hs-identifier hs-var hs-var">V2Causal.value</span></span><span> </span><span class="annot"><span class="annottext">CausalBranch m
</span><a href="#local-6989586621680729151"><span class="hs-identifier hs-var">cb</span></a></span><span>
</span><span id="line-661"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680729148"><span class="annot"><span class="annottext">Map NameSegment (Set Referent)
</span><a href="#local-6989586621680729148"><span class="hs-identifier hs-var">shallowTermNames</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680729147"><span class="annot"><span class="annottext">Map NameSegment (Set Reference)
</span><a href="#local-6989586621680729147"><span class="hs-identifier hs-var">shallowTypeNames</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Referent (m MdValues) -&gt; Set Referent
forall k a. Map k a -&gt; Set k
</span><span class="hs-identifier hs-var">Map.keysSet</span></span><span> </span><span class="annot"><span class="annottext">(Map Referent (m MdValues) -&gt; Set Referent)
-&gt; Map NameSegment (Map Referent (m MdValues))
-&gt; Map NameSegment (Set Referent)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Branch m -&gt; Map NameSegment (Map Referent (m MdValues))
forall (m :: * -&gt; *).
Branch m -&gt; Map NameSegment (Map Referent (m MdValues))
</span><span class="hs-identifier hs-var hs-var">V2Branch.terms</span></span><span> </span><span class="annot"><span class="annottext">Branch m
</span><a href="#local-6989586621680729150"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map Reference (m MdValues) -&gt; Set Reference
forall k a. Map k a -&gt; Set k
</span><span class="hs-identifier hs-var">Map.keysSet</span></span><span> </span><span class="annot"><span class="annottext">(Map Reference (m MdValues) -&gt; Set Reference)
-&gt; Map NameSegment (Map Reference (m MdValues))
-&gt; Map NameSegment (Set Reference)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Branch m -&gt; Map NameSegment (Map Reference (m MdValues))
forall (m :: * -&gt; *).
Branch m -&gt; Map NameSegment (Map Reference (m MdValues))
</span><span class="hs-identifier hs-var hs-var">V2Branch.types</span></span><span> </span><span class="annot"><span class="annottext">Branch m
</span><a href="#local-6989586621680729150"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-662"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621680729143"><span class="annot"><span class="annottext">Map (NonEmpty NameSegment) (Set Referent)
</span><a href="#local-6989586621680729143"><span class="hs-identifier hs-var">prefixedChildTerms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680729142"><span class="annot"><span class="annottext">Map (NonEmpty NameSegment) (Set Reference)
</span><a href="#local-6989586621680729142"><span class="hs-identifier hs-var">prefixedChildTypes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-663"></span><span>        </span><span class="annot"><span class="annottext">Map
  NameSegment
  (Map (NonEmpty NameSegment) (Set Referent),
   Map (NonEmpty NameSegment) (Set Reference))
-&gt; (Map (NonEmpty NameSegment) (Set Referent),
    Map (NonEmpty NameSegment) (Set Reference))
forall (t :: * -&gt; *) m. (Foldable t, Monoid m) =&gt; t m -&gt; m
</span><span class="hs-identifier hs-var">fold</span></span><span> </span><span class="annot"><span class="annottext">(Map
   NameSegment
   (Map (NonEmpty NameSegment) (Set Referent),
    Map (NonEmpty NameSegment) (Set Reference))
 -&gt; (Map (NonEmpty NameSegment) (Set Referent),
     Map (NonEmpty NameSegment) (Set Reference)))
-&gt; m (Map
        NameSegment
        (Map (NonEmpty NameSegment) (Set Referent),
         Map (NonEmpty NameSegment) (Set Reference)))
-&gt; m (Map (NonEmpty NameSegment) (Set Referent),
      Map (NonEmpty NameSegment) (Set Reference))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map NameSegment (CausalBranch m)
-&gt; (NameSegment
    -&gt; CausalBranch m
    -&gt; m (Map (NonEmpty NameSegment) (Set Referent),
          Map (NonEmpty NameSegment) (Set Reference)))
-&gt; m (Map
        NameSegment
        (Map (NonEmpty NameSegment) (Set Referent),
         Map (NonEmpty NameSegment) (Set Reference)))
forall i (t :: * -&gt; *) (f :: * -&gt; *) a b.
(TraversableWithIndex i t, Applicative f) =&gt;
t a -&gt; (i -&gt; a -&gt; f b) -&gt; f (t b)
</span><span class="hs-identifier hs-var">ifor</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Branch m -&gt; Map NameSegment (CausalBranch m)
forall (m :: * -&gt; *). Branch m -&gt; Map NameSegment (CausalBranch m)
</span><span class="hs-identifier hs-var hs-var">V2Branch.children</span></span><span> </span><span class="annot"><span class="annottext">Branch m
</span><a href="#local-6989586621680729150"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((NameSegment
  -&gt; CausalBranch m
  -&gt; m (Map (NonEmpty NameSegment) (Set Referent),
        Map (NonEmpty NameSegment) (Set Reference)))
 -&gt; m (Map
         NameSegment
         (Map (NonEmpty NameSegment) (Set Referent),
          Map (NonEmpty NameSegment) (Set Reference))))
-&gt; (NameSegment
    -&gt; CausalBranch m
    -&gt; m (Map (NonEmpty NameSegment) (Set Referent),
          Map (NonEmpty NameSegment) (Set Reference)))
-&gt; m (Map
        NameSegment
        (Map (NonEmpty NameSegment) (Set Referent),
         Map (NonEmpty NameSegment) (Set Reference)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680729139"><span class="annot"><span class="annottext">NameSegment
</span><a href="#local-6989586621680729139"><span class="hs-identifier hs-var">nameSegment</span></a></span></span><span> </span><span id="local-6989586621680729138"><span class="annot"><span class="annottext">CausalBranch m
</span><a href="#local-6989586621680729138"><span class="hs-identifier hs-var">cb</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[NameSegment]
-&gt; CausalBranch m
-&gt; m (Map (NonEmpty NameSegment) (Set Referent),
      Map (NonEmpty NameSegment) (Set Reference))
forall (m :: * -&gt; *).
Monad m =&gt;
[NameSegment]
-&gt; CausalBranch m
-&gt; m (Map (NonEmpty NameSegment) (Set Referent),
      Map (NonEmpty NameSegment) (Set Reference))
</span><a href="#local-6989586621680729171"><span class="hs-identifier hs-var">nameMapsFromV2Branch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NameSegment
</span><a href="#local-6989586621680729139"><span class="hs-identifier hs-var">nameSegment</span></a></span><span> </span><span class="annot"><span class="annottext">NameSegment -&gt; [NameSegment] -&gt; [NameSegment]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[NameSegment]
</span><a href="#local-6989586621680729152"><span class="hs-identifier hs-var">reversedNamePrefix</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CausalBranch m
</span><a href="#local-6989586621680729138"><span class="hs-identifier hs-var">cb</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-664"></span><span>      </span><span class="annot"><span class="annottext">(Map (NonEmpty NameSegment) (Set Referent),
 Map (NonEmpty NameSegment) (Set Reference))
-&gt; m (Map (NonEmpty NameSegment) (Set Referent),
      Map (NonEmpty NameSegment) (Set Reference))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(NameSegment -&gt; NonEmpty NameSegment)
-&gt; Map NameSegment (Set Referent)
-&gt; Map (NonEmpty NameSegment) (Set Referent)
forall k2 k1 a. Ord k2 =&gt; (k1 -&gt; k2) -&gt; Map k1 a -&gt; Map k2 a
</span><span class="hs-identifier hs-var">Map.mapKeys</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NameSegment -&gt; [NameSegment] -&gt; NonEmpty NameSegment
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">NEList.:|</span></span><span> </span><span class="annot"><span class="annottext">[NameSegment]
</span><a href="#local-6989586621680729152"><span class="hs-identifier hs-var">reversedNamePrefix</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map NameSegment (Set Referent)
</span><a href="#local-6989586621680729148"><span class="hs-identifier hs-var">shallowTermNames</span></a></span><span> </span><span class="annot"><span class="annottext">Map (NonEmpty NameSegment) (Set Referent)
-&gt; Map (NonEmpty NameSegment) (Set Referent)
-&gt; Map (NonEmpty NameSegment) (Set Referent)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map (NonEmpty NameSegment) (Set Referent)
</span><a href="#local-6989586621680729143"><span class="hs-identifier hs-var">prefixedChildTerms</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(NameSegment -&gt; NonEmpty NameSegment)
-&gt; Map NameSegment (Set Reference)
-&gt; Map (NonEmpty NameSegment) (Set Reference)
forall k2 k1 a. Ord k2 =&gt; (k1 -&gt; k2) -&gt; Map k1 a -&gt; Map k2 a
</span><span class="hs-identifier hs-var">Map.mapKeys</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NameSegment -&gt; [NameSegment] -&gt; NonEmpty NameSegment
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">NEList.:|</span></span><span> </span><span class="annot"><span class="annottext">[NameSegment]
</span><a href="#local-6989586621680729152"><span class="hs-identifier hs-var">reversedNamePrefix</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map NameSegment (Set Reference)
</span><a href="#local-6989586621680729147"><span class="hs-identifier hs-var">shallowTypeNames</span></a></span><span> </span><span class="annot"><span class="annottext">Map (NonEmpty NameSegment) (Set Reference)
-&gt; Map (NonEmpty NameSegment) (Set Reference)
-&gt; Map (NonEmpty NameSegment) (Set Reference)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map (NonEmpty NameSegment) (Set Reference)
</span><a href="#local-6989586621680729142"><span class="hs-identifier hs-var">prefixedChildTypes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-665"></span><span>
</span><span id="line-666"></span><span id="local-6989586621680729136"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#mkGetDeclType"><span class="hs-identifier hs-type">mkGetDeclType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621680729136"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680729136"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-667"></span><span id="mkGetDeclType"><span class="annot"><span class="annottext">mkGetDeclType :: m (Reference -&gt; Transaction ConstructorType)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#mkGetDeclType"><span class="hs-identifier hs-var hs-var">mkGetDeclType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-668"></span><span>  </span><span id="local-6989586621680729134"><span class="annot"><span class="annottext">Cache Reference ConstructorType
</span><a href="#local-6989586621680729134"><span class="hs-identifier hs-var">declTypeCache</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Word -&gt; m (Cache Reference ConstructorType)
forall (m :: * -&gt; *) k v.
(MonadIO m, Ord k) =&gt;
Word -&gt; m (Cache k v)
</span><span class="hs-identifier hs-var">Cache.semispaceCache</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">2048</span></span><span>
</span><span id="line-669"></span><span>  </span><span class="hs-identifier">pure</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680729132"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621680729132"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-670"></span><span>    </span><span id="local-6989586621680729131"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680729131"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Transaction Connection
</span><span class="hs-identifier hs-var">Sqlite.unsafeGetConnection</span></span><span>
</span><span id="line-671"></span><span>    </span><span class="annot"><span class="annottext">IO ConstructorType -&gt; Transaction ConstructorType
forall a. IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="annot"><span class="annottext">(IO ConstructorType -&gt; Transaction ConstructorType)
-&gt; IO ConstructorType -&gt; Transaction ConstructorType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Cache Reference ConstructorType
-&gt; (Reference -&gt; IO ConstructorType)
-&gt; Reference
-&gt; IO ConstructorType
forall (m :: * -&gt; *) k v.
MonadIO m =&gt;
Cache k v -&gt; (k -&gt; m v) -&gt; k -&gt; m v
</span><span class="hs-identifier hs-var">Cache.apply</span></span><span> </span><span class="annot"><span class="annottext">Cache Reference ConstructorType
</span><a href="#local-6989586621680729134"><span class="hs-identifier hs-var">declTypeCache</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621680729128"><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621680729128"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Transaction ConstructorType -&gt; Connection -&gt; IO ConstructorType
forall a. Transaction a -&gt; Connection -&gt; IO a
</span><span class="hs-identifier hs-var">Sqlite.unsafeUnTransaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getDeclType"><span class="hs-identifier hs-var">getDeclType</span></a></span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621680729128"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680729131"><span class="hs-identifier hs-var">conn</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Reference
</span><a href="#local-6989586621680729132"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-672"></span></pre></body></html>